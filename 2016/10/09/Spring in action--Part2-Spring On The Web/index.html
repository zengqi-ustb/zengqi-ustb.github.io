
 <!DOCTYPE HTML>
<html lang="default">
<head>
  <meta charset="UTF-8">
  
    <title>Spring in action--Part2-Spring On The Web | 曾先生&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="曾奇">
    

    
    <meta name="description" content="Chapter5.Building Spring web applications

State management, workflow, and validation are allimportant features a java web developer needs to be addressed. None of these is made any easier given the H">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring in action--Part2-Spring On The Web">
<meta property="og:url" content="http://yoursite.com/2016/10/09/Spring in action--Part2-Spring On The Web/index.html">
<meta property="og:site_name" content="曾先生's Blog">
<meta property="og:description" content="Chapter5.Building Spring web applications

State management, workflow, and validation are allimportant features a java web developer needs to be addressed. None of these is made any easier given the H">
<meta property="og:image" content="http://img.blog.csdn.net/20161009102802694">
<meta property="og:image" content="http://img.blog.csdn.net/20161009201431730">
<meta property="og:image" content="http://img.blog.csdn.net/20161009220654575">
<meta property="og:image" content="http://img.blog.csdn.net/20161009220727741">
<meta property="og:image" content="http://img.blog.csdn.net/20161010102136038">
<meta property="og:image" content="http://img.blog.csdn.net/20161010103654620">
<meta property="og:image" content="http://img.blog.csdn.net/20161010105750385">
<meta property="og:image" content="http://img.blog.csdn.net/20161011101035829">
<meta property="og:image" content="http://img.blog.csdn.net/20161012173353401">
<meta property="og:image" content="http://img.blog.csdn.net/20161012214149453">
<meta property="og:image" content="http://img.blog.csdn.net/20161012220642871">
<meta property="og:image" content="http://img.blog.csdn.net/20161012225413098">
<meta property="og:image" content="http://img.blog.csdn.net/20161013102456498">
<meta property="og:image" content="http://img.blog.csdn.net/20161013104623019">
<meta property="og:image" content="http://img.blog.csdn.net/20161013115928101">
<meta property="og:image" content="http://img.blog.csdn.net/20161013140408442">
<meta property="og:image" content="http://img.blog.csdn.net/20161013143622471">
<meta property="og:image" content="http://img.blog.csdn.net/20161013150623716">
<meta property="og:image" content="http://img.blog.csdn.net/20161013153508572">
<meta property="og:image" content="http://img.blog.csdn.net/20161013162335148">
<meta property="og:image" content="http://img.blog.csdn.net/20161013170225200">
<meta property="og:image" content="http://img.blog.csdn.net/20161013171229418">
<meta property="og:image" content="http://img.blog.csdn.net/20161013171321084">
<meta property="og:updated_time" content="2017-03-18T14:29:15.070Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring in action--Part2-Spring On The Web">
<meta name="twitter:description" content="Chapter5.Building Spring web applications

State management, workflow, and validation are allimportant features a java web developer needs to be addressed. None of these is made any easier given the H">
<meta name="twitter:image" content="http://img.blog.csdn.net/20161009102802694">

    
    <link rel="alternative" href="/atom.xml" title="曾先生&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="曾先生&#39;s Blog" title="曾先生&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="曾先生&#39;s Blog">曾先生&#39;s Blog</a></h1>
				<h2 class="blog-motto">飞面神教四川担担面教区主教</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于我</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/09/Spring in action--Part2-Spring On The Web/" title="Spring in action--Part2-Spring On The Web" itemprop="url">Spring in action--Part2-Spring On The Web</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="曾奇" target="_blank" itemprop="author">曾奇</a>
		
  <p class="article-time">
    <time datetime="2016-10-09T07:23:39.000Z" itemprop="datePublished"> Published 2016-10-09</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">Chapter5.Building Spring web applications</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.1.</span> <span class="toc-text">5.1Getting started with Spring MVC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">5.1.1Following the life of a request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">5.1.2Setting up Spring MVC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.1.3.</span> <span class="toc-text">5.1.3Introducing the Spittr application</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.2.</span> <span class="toc-text">5.2Writing a simple controller</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">5.2.1Testing the controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">5.2.2 Defining class-level request handling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.2.3.</span> <span class="toc-text">5.2.3Passing model data to the view</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.3.</span> <span class="toc-text">5.3Accepting request input</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.3.1.</span> <span class="toc-text">5.3.1Taking query parameters</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.3.2.</span> <span class="toc-text">5.3.2Taking input via path parameters</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.4.</span> <span class="toc-text">5.4Processing forms</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.4.1.</span> <span class="toc-text">5.4.1Writing a form-handling controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.4.2.</span> <span class="toc-text">5.4.2Validating forms</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.5.</span> <span class="toc-text">5.5Summary</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">Chapter6.Rendering web views</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.1.</span> <span class="toc-text">6.1Understanding view resolution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.2.</span> <span class="toc-text">6.2Creating JSP views</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.2.1.</span> <span class="toc-text">6.2.1Configuring a JSP-ready view resolver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.2.2.</span> <span class="toc-text">6.2.2Using Spring’s JSP libraries</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.3.</span> <span class="toc-text">6.3Defining a layout with Apache Tiles views</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.4.</span> <span class="toc-text">6.4Working with Thymeleaf</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.4.1.</span> <span class="toc-text">6.4.1Configuring a Thymeleaf view resolver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.4.2.</span> <span class="toc-text">6.4.2Defining Thymeleaf templates</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.5.</span> <span class="toc-text">6.5Summary</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">Chapter7.Advanced Spring MVC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.1.</span> <span class="toc-text">7.1Alternate Spring MVC configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.1.1.</span> <span class="toc-text">7.1.1Customizing DispatcherServlet configuration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.1.2.</span> <span class="toc-text">7.1.2Adding additional servlets and filters</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.1.3.</span> <span class="toc-text">7.1.3 Declaring DispatcherServlet in web.xml</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.2.</span> <span class="toc-text">7.2Processing multipart form data</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.2.1.</span> <span class="toc-text">7.2.1Configuring a multipart resolver</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.3.</span> <span class="toc-text">7.2Handling multipart requests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.4.</span> <span class="toc-text">7.3Handling exceptions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.4.1.</span> <span class="toc-text">7.3.1Mapping exceptions to HTTP status codes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.4.2.</span> <span class="toc-text">7.3.2Writing exception-handling methods</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.5.</span> <span class="toc-text">7.4Advising controllers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.6.</span> <span class="toc-text">7.5Carrying data across redirect requests</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.6.1.</span> <span class="toc-text">7.5.1Redirecting with URL templates</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.6.2.</span> <span class="toc-text">7.5.2Working with flash attributes</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.7.</span> <span class="toc-text">7.6Summary</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">Chapter8.Working with Spring Web Flow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.1.</span> <span class="toc-text">8.1Configuring Web Flow in Spring</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.1.1.</span> <span class="toc-text">8.1.1Wiring a flow executor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.1.2.</span> <span class="toc-text">8.1.2Configuring a flow registry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.1.3.</span> <span class="toc-text">8.1.3 Handling flow requests</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.2.</span> <span class="toc-text">8.2 The components of a flow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.2.1.</span> <span class="toc-text">8.2.1 States</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.2.2.</span> <span class="toc-text">8.2.2Transitions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.2.3.</span> <span class="toc-text">8.2.3Flow data</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.</span> <span class="toc-text">8.3Putting it all together: the pizza flow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.1.</span> <span class="toc-text">8.3.1Defining the base flow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.2.</span> <span class="toc-text">8.3.2Collecting customer information</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.3.</span> <span class="toc-text">8.3.3Building an order</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.4.</span> <span class="toc-text">8.3.4 Taking payment</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.4.</span> <span class="toc-text">8.4 Securing web flows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.5.</span> <span class="toc-text">8.5Summary</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">Chapter9.Securing web applications</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.1.</span> <span class="toc-text">9.1Getting started with Spring Security</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.1.1.</span> <span class="toc-text">9.1.1Understanding Spring Security modules</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.1.2.</span> <span class="toc-text">9.1.2Filtering web requests</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.1.3.</span> <span class="toc-text">9.1.3Writing a simple security configuration</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.</span> <span class="toc-text">9.2Selecting user details services</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.1.</span> <span class="toc-text">9.2.1Working with an in-memory user store</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.2.</span> <span class="toc-text">9.2.2Authenticating against database tables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.3.</span> <span class="toc-text">9.2.3Applying LDAP-backed authentication</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.4.</span> <span class="toc-text"> 9.2.4Configuring a custom user service</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.3.</span> <span class="toc-text">9.3Intercepting requests</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.3.1.</span> <span class="toc-text">9.3.1Securing with Spring Expressions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.3.2.</span> <span class="toc-text">9.3.2Enforcing channel security</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.3.3.</span> <span class="toc-text">9.3.3Preventing cross-site request forgery</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.</span> <span class="toc-text">9.4Authenticating users</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.1.</span> <span class="toc-text">9.4.1Adding a custom login page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.2.</span> <span class="toc-text">9.4.2 Enabling HTTP Basic authentication</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.3.</span> <span class="toc-text">9.4.3Enabling remember-me functionality</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.4.</span> <span class="toc-text">9.4.4Logging out</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.5.</span> <span class="toc-text">9.5Securing the view</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.5.1.</span> <span class="toc-text">9.5.1 Using Spring Security’s JSP tag library</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.5.2.</span> <span class="toc-text">9.5.2Working with Thymeleaf’s Spring Security dialect</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.6.</span> <span class="toc-text">9.6Summary</span></a></li></ol></li></ol></li></ol>
		
		</div>
		
		<h1>Chapter5.Building Spring web applications</h1>

<p>State management, workflow, and validation are all<br>important features a java web developer needs to be addressed. <strong>None of these is made any easier given the HTTP protocol’s stateless nature</strong>.HTTP是无状态协议。</p>
<h3>5.1Getting started with Spring MVC</h3>

<p>Let’s take a look at how a request makes its way from the client through the components in Spring MVC, ultimately resulting in a request that goes back to the client.</p>
<h4>5.1.1Following the life of a request</h4>

<p>The request is a busy creature. From the time it leaves the browser until it returns with a response, it makes several stops, each time dropping off a bit of information and picking up some more.每次失去和增加一些信息。Figure 5.1 shows all the stops the request makes as it travels through Spring MVC.<br><img src="http://img.blog.csdn.net/20161009102802694" alt=""></p>
<p>下面是每部分的讲解：</p>
<p>When the request leaves the browser <strong>(Part 1)</strong>, it carries information about what the user is asking for. At the least, the request will be carrying the requested URL. But it may also carry additional data, such as the information submitted in a form by the user.</p>
<p><strong>The DispatcherServlet’s job is to send the request on to a Spring MVC controller</strong>. <strong>A controller is a Spring component that processes the request(controller是重点)</strong>. But a typical application may have <strong>several controllers</strong>, and DispatcherServlet needs some help deciding which controller to send the request to. So the DispatcherServlet consults one or more <strong>handler mappings (Part 2)</strong>to figure out where the request’s next stop will be. The handler mapping pays particular attention to the URL carried by the request when making its decision.这一步就是DispatcherServlet给特定的request选择合适的controller。</p>
<p>Once an appropriate controller has been chosen, DispatcherServlet sends the request on its merry way to the chosen controller <strong>(Part 3)</strong>. At the controller, the request drops off its payload (the information submitted by the user) and patiently waits while<br>the controller processes that information. (<strong>Actually, a well-designed controller performs little or no processing itself and instead delegates responsibility for the business logic to one or more service objects.</strong>)controller自己最好不处理logic，交给service objects进行处理。</p>
<p>The logic performed by a controller often results in some information that needs to be carried back to the user and displayed in the browser. This information is<br>referred to as the model. <strong>But sending raw information back to the user isn’t sufficient—it needs to be formatted in a user-friendly format, typically HTML</strong>. For that, the information needs to be given to a view, typically a JavaServer Page (JSP).</p>
<p>One of the last things a controller does is package up the model data and <strong>identify the name of a view</strong> that should render the output. 只是指定名字，这样能够实现解耦。</p>
<p>It then sends the request, along with the model and view name, back to the DispatcherServlet <strong>(Part 4)</strong>.</p>
<p>So that the controller doesn’t get coupled to a particular view, the view name passed back to DispatcherServlet doesn’t directly identify a specific JSP. It doesn’t even necessarily suggest that the view is a JSP. Instead, it only carries a logical name that will be used to look up the actual view that will produce the result. <strong>The DispatcherServlet consults a view resolver (Part 5) to map the logical view name to a specific view implementation, which may or may not be a JSP</strong>.</p>
<p>Now that DispatcherServlet knows which view will render the result, the request’s job is almost over. Its final stop is at the <strong>view implementation (Part 6)</strong>, typically a JSP, where it delivers the model data. The request’s job is finally done. The view will use the model data to render output that will be carried back to the client by the (notso-hardworking) response object <strong>(Part 7)</strong>.</p>
<h4>5.1.2Setting up Spring MVC</h4>

<p>For now, you’ll take the simplest approach to configuring Spring MVC: you’ll do just enough configuring to be able to run the controllers you create.只需要配置能让controller跑起来的配置就行。</p>
<p><strong>CONFIGURING DISPATCHERSERVLET</strong></p>
<p><strong>DispatcherServlet is the centerpiece of Spring MVC</strong>. It’s where the request first hits the framework, and it’s responsible for <strong>routing</strong> the request through all the other components.</p>
<p>Instead of a web.xml file, you’re going to use Java to configure DispatcherServlet in the servlet container. The following listing shows the Java class you’ll need.以前是只能在web.xml中配置。现在应该两个地方都可以。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//Configuring DispatcherServlet</span><br><span class="line">package spittr.config;</span><br><span class="line">import org.springframework.web.servlet.support.</span><br><span class="line">AbstractAnnotationConfigDispatcherServletInitializer;</span><br><span class="line">public class SpittrWebAppInitializer</span><br><span class="line">extends AbstractAnnotationConfigDispatcherServletInitializer &#123;</span><br><span class="line">@Override</span><br><span class="line">protected String[] getServletMappings() &#123;//Map //DispatcherServlet to /</span><br><span class="line">return new String[] &#123; &quot;/&quot; &#125;;</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">protected Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">return new Class&lt;?&gt;[] &#123; RootConfig.class &#125;;</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">protected Class&lt;?&gt;[] getServletConfigClasses() &#123;//Specify configuration class</span><br><span class="line">return new Class&lt;?&gt;[] &#123; WebConfig.class &#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Any class that extends AbstractAnnotationConfigDispatcherServletInitializer will automatically be used to configure DispatcherServlet and the Spring application context in the application’s servlet context.</p>
<p>Looking at listing 5.1, you can see that SpittrWebAppInitializer overrides three methods.</p>
<p>1.The first method, <strong>getServletMappings()</strong>, identifies one or more paths that DispatcherServlet will be mapped to. In this case, it’s mapped to <strong>/</strong>, indicating that it will be the application’s <strong>default servlet</strong>. <strong>It will handle all requests coming into the application</strong>.map到/就handle每个request，其他的同理。</p>
<p>In order to understand the other two methods, you must first understand the relationship between <strong>DispatcherServlet</strong> and a servlet listener known as <strong>ContextLoaderListener</strong>.要弄清后两个方法，先要清楚这两者之间的关系。</p>
<p>记住，后两种方法现在还没有总结呢，等理清关系后再来。</p>
<p><strong>A TALE OF TWO APPLICATION CONTEXTS</strong></p>
<p>Under the covers, AbstractAnnotationConfigDispatcherServletInitializer creates both a <strong>DispatcherServlet</strong> and a <strong>ContextLoaderListener</strong>. The @Configuration<br>classes returned from <strong>getServletConfigClasses()</strong> will define beans for <strong>DispatcherServlet’s application context</strong>. Meanwhile, the @Configuration class’s returned <strong>getRootConfigClasses()</strong> will be used to configure the application context created by <strong>ContextLoaderListener</strong>.</p>
<p>In this case, your root configuration is defined in <strong>RootConfig</strong>, whereas DispatcherServlet’s configuration is declared in <strong>WebConfig</strong>. You’ll see what those two configuration classes look like in a moment.不同的两个东西，在不同的地方定义。</p>
<p>If you’re not yet working with a Servlet 3.0-capable server,那么你就只能在web.xml中定义了。We’ll look at web.xml and other configuration options in chapter 7. </p>
<p><strong>ENABLING SPRING MVC</strong></p>
<p>The very simplest Spring MVC configuration you can create is a class annotated with @EnableWebMvc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package spittr.config;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebMvc</span><br><span class="line">public class WebConfig &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This will work, and it will enable Spring MVC. But it leaves a lot to be desired.上面的代码虽然能enable，但是太朴素了吧，好多功能都没有配置:</p>
<p>1.No view resolver is configured. As such, Spring will default to using <strong>BeanNameViewResolver（默认用这个view resolver）</strong>, a view resolver that resolves views by looking for beans whose ID matches the view name and whose class implements the View interface.</p>
<p>2.<strong>Component-scanning isn’t enabled</strong>. Consequently, the only way Spring will find any controllers is if you declare them explicitly in the configuration.除非你显式地定义它为controller。</p>
<p>3.As it is, DispatcherServlet is mapped as the default servlet for the application and will handle all requests, including requests for static resources, such as images and stylesheets (which is probably not what you want in most cases).默认map所有request，包括静态资源的请求，但是这样不是你想要的。</p>
<p>The new WebConfig in the next listing addresses these concerns.下面这个应该好很多了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//A minimal yet useful configuration for Spring MVC</span><br><span class="line">package spittr.config;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.ComponentScan;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.servlet.ViewResolver;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.</span><br><span class="line">DefaultServletHandlerConfigurer;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.</span><br><span class="line">WebMvcConfigurerAdapter;</span><br><span class="line">import org.springframework.web.servlet.view.</span><br><span class="line">InternalResourceViewResolver;</span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebMvc  //Enable Spring MVC</span><br><span class="line">@ComponentScan(&quot;spitter.web&quot;)//Enable </span><br><span class="line">//component-scanning</span><br><span class="line">public class WebConfig</span><br><span class="line">extends WebMvcConfigurerAdapter &#123;</span><br><span class="line">@Bean</span><br><span class="line">public ViewResolver viewResolver() &#123;</span><br><span class="line">InternalResourceViewResolver resolver =//Configure a JSP view resolver</span><br><span class="line">new InternalResourceViewResolver();</span><br><span class="line">resolver.setPrefix(&quot;/WEB-INF/views/&quot;);</span><br><span class="line">resolver.setSuffix(&quot;.jsp&quot;);</span><br><span class="line">resolver.setExposeContextBeansAsAttributes(true);</span><br><span class="line">return resolver;</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">//Configure static content handling</span><br><span class="line">public void configureDefaultServletHandling(</span><br><span class="line">DefaultServletHandlerConfigurer configurer) &#123;</span><br><span class="line">configurer.enable();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的：</p>
<p>The first thing to notice in listing 5.2 is that WebConfig is now annotated with <strong>@ComponentScan</strong> so that the <strong>spitter.web package</strong> will be scanned for components. As you’ll soon see, the controllers you write will be annotated with <strong>@Controller</strong>, <strong>which will make them candidates for component-scanning</strong>. Consequently, you won’t have to<br>explicitly declare any controllers in the configuration class.</p>
<p>Next, you add a ViewResolver bean. More specifically, it’s an InternalResourceViewResolver. We’ll talk more about view resolvers in chapter 6. For now,<br>just know that <strong>it’s configured to look for JSP files by wrapping view names with a specific prefix and suffix</strong> (for example, a view name of home will be resolved as /WEB-INF/ views/home.jsp).</p>
<p>Finally, this new WebConfig class extends WebMvcConfigurerAdapter and overrides<br>its <strong>configureDefaultServletHandling()</strong> method. By calling enable() on the given DefaultServletHandlerConfigurer, you’re asking DispatcherServlet to forward requests for static resources to the servlet container’s default servlet and not to try to handle them itself.关于静态资源的处理。</p>
<p>这样正好解决了上面的三个问题。完美。</p>
<p>With <strong>WebConfig</strong> settled, what about <strong>RootConfig</strong>? Because this chapter is focused<br>on web development, and web configuration is done in the application context created by DispatcherServlet, you’ll <strong>keep RootConfig relatively simple for now</strong>:暂时简单配置RootConfig就行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package spittr.config;</span><br><span class="line">import org.springframework.context.annotation.ComponentScan;</span><br><span class="line">import org.springframework.context.annotation.ComponentScan.Filter;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.FilterType;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line">@Configuration</span><br><span class="line">@ComponentScan(basePackages=&#123;&quot;spitter&quot;&#125;,</span><br><span class="line">excludeFilters=&#123;</span><br><span class="line">@Filter(type=FilterType.ANNOTATION, value=EnableWebMvc.class)</span><br><span class="line">&#125;)</span><br><span class="line">public class RootConfig &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4>5.1.3Introducing the Spittr application</h4>

<p>开始练手。项目需求：模仿twitter，叫Spittr，The Spittr application has two essential domain concepts: <strong>spitters</strong> (the users of the application) and <strong>spittles</strong> (the brief status updates that users publish). </p>
<p>In this chapter, you’ll build out the <strong>web layer</strong> of the application, create <strong>controllers</strong> that display spittles, and process forms where users register as spitters.</p>
<p>The stage is now set. You’ve configured DispatcherServlet, enabled essential Spring MVC components, and established a target application. Let’s turn to the meat of the chapter: handling web requests with Spring MVC controllers.</p>
<h3>5.2Writing a simple controller</h3>

<p>In Spring MVC, controllers are just classes with methods that are annotated with <strong>@RequestMapping</strong> to declare the kind of requests they’ll handle.</p>
<p>一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//HomeController: an example of an extremely //simple controller</span><br><span class="line">package spittr.web;</span><br><span class="line">import static org.springframework.web.bind.annotation.RequestMethod.*;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line">@Controller  //Declared to be a controller</span><br><span class="line">public class HomeController &#123;</span><br><span class="line">@RequestMapping(value=&quot;/&quot;, method=GET)//Handle //GET requests for /</span><br><span class="line">public String home() &#123;</span><br><span class="line">return &quot;home&quot;;  //View name is home</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The first thing you’ll notice about HomeController is that it’s annotated with <strong>@Controller</strong>. Although it’s clear that this annotation declares a controller, <strong>the annotation has little to do with Spring MVC</strong>.</p>
<p><strong>@Controller is a stereotype annotation, based on the @Component annotation</strong>. Its purpose here is entirely for the benefit of component-scanning. Because HomeController is annotated with @Controller, the component scanner will automatically pick up HomeController and declare it as a bean in the Spring application context.</p>
<p>You could have annotated HomeController with @Component, and it would have had the same effect, but it would have been less expressive about what type of component HomeController is.也可以用@Component，完全能够达到作用，但是就不expressive啦。</p>
<p>Given the way you configured InternalResourceViewResolver, the view name “home” will be resolved as a JSP at /WEB INF/views/home.jsp. For now, you’ll keep the Spittr application’s home page rather basic, as shown next.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//Spittr home page, defined as a simple JSP</span><br><span class="line">&lt;%@ taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot; %&gt;</span><br><span class="line">&lt;%@ page session=&quot;false&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Spittr&lt;/title&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot;</span><br><span class="line">type=&quot;text/css&quot;</span><br><span class="line">href=&quot;&lt;c:url value=&quot;/resources/style.css&quot; /&gt;&quot; &gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to Spittr&lt;/h1&gt;</span><br><span class="line">&lt;a href=&quot;&lt;c:url value=&quot;/spittles&quot; /&gt;&quot;&gt;Spittles&lt;/a&gt; |</span><br><span class="line">&lt;a href=&quot;&lt;c:url value=&quot;/spitter/register&quot; /&gt;&quot;&gt;Register&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>The obvious way to test a controller may be to build and deploy the application and poke at it with a web browser, but <strong>an automated test will give you quicker feedback and more consistent hands-off results</strong>. So, let’s cover HomeController with a test.</p>
<h4>5.2.1Testing the controller</h4>

<p>Starting with Spring 3.2, however, you have a way to test Spring MVC controllers <strong>as controllers, not merely as POJOs</strong>. Spring now includes a mechanism for mocking all the mechanics of Spring MVC and executing HTTP requests against controllers. This<br>will enable you to test your controllers <strong>without firing up a web server or web browser</strong>.<br>测试上面的home()方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package spittr.web;</span><br><span class="line">import static</span><br><span class="line">org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;</span><br><span class="line">import static</span><br><span class="line">org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;</span><br><span class="line">import static</span><br><span class="line">org.springframework.test.web.servlet.setup.MockMvcBuilders.*;</span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.springframework.test.web.servlet.MockMvc;</span><br><span class="line">import spittr.web.HomeController;</span><br><span class="line">public class HomeControllerTest &#123;</span><br><span class="line">@Test</span><br><span class="line">public void testHomePage() throws Exception &#123;</span><br><span class="line">HomeController controller = new HomeController();</span><br><span class="line">MockMvc mockMvc =  //Set up MockMvc</span><br><span class="line">standaloneSetup(controller).build();</span><br><span class="line">mockMvc.perform(get(&quot;/&quot;))  //Perform GET /</span><br><span class="line">.andExpect(view().name(&quot;home&quot;));//Expect home //view</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4>5.2.2 Defining class-level request handling</h4><br>改为class-level request handling:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;/&quot;)</span><br><span class="line">public class HomeController &#123;</span><br><span class="line">@RequestMapping(method=GET)</span><br><span class="line">public String home() &#123;</span><br><span class="line">return &quot;home&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>HomeController’s home() method is mapped to handle GET requests for both / and /homepage requests:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">@RequestMapping(&#123;&quot;/&quot;, &quot;/homepage&quot;&#125;)</span><br><span class="line">public class HomeController &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br><h4>5.2.3Passing model data to the view</h4>

<p>In the Spittr application, you’ll need a page that displays a list of the most recent spittles that have been submitted.</p>
<p>Therefore, you’ll need a new method to serve such a page.</p>
<p><strong>First you need to define a repository for data access</strong>.At the moment, you only need a repository that can fetch a list of the spittles. SpittleRepository, as defined here, is a sufficient start:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//定义一个接口</span><br><span class="line">package spittr.data;</span><br><span class="line">import java.util.List;</span><br><span class="line">import spittr.Spittle;</span><br><span class="line">public interface SpittleRepository &#123;</span><br><span class="line">List&lt;Spittle&gt; findSpittles(long max, int count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In order to get the 20 most recent Spittle objects, you can call findSpittles() like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Spittle&gt; recent =</span><br><span class="line">spittleRepository.findSpittles(Long.MAX_VALUE, 20);</span><br></pre></td></tr></table></figure>
<p>Spittle:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">//Spittle class: carries a message, a timestamp, //and a location</span><br><span class="line">package spittr;</span><br><span class="line">import java.util.Date;</span><br><span class="line">public class Spittle &#123;</span><br><span class="line">private final Long id;</span><br><span class="line">private final String message;</span><br><span class="line">private final Date time;</span><br><span class="line">private Double latitude;</span><br><span class="line">private Double longitude;</span><br><span class="line">public Spittle(String message, Date time) &#123;</span><br><span class="line">this(message, time, null, null);</span><br><span class="line">&#125;</span><br><span class="line">public Spittle(</span><br><span class="line">String message, Date time, Double longitude, Double latitude) &#123;</span><br><span class="line">this.id = null;</span><br><span class="line">this.message = message;</span><br><span class="line">this.time = time;</span><br><span class="line">this.longitude = longitude;</span><br><span class="line">this.latitude = latitude;</span><br><span class="line">&#125;</span><br><span class="line">public long getId() &#123;</span><br><span class="line">return id;</span><br><span class="line">&#125;</span><br><span class="line">public String getMessage() &#123;</span><br><span class="line">return message;</span><br><span class="line">&#125;</span><br><span class="line">public Date getTime() &#123;</span><br><span class="line">return time;</span><br><span class="line">&#125;</span><br><span class="line">public Double getLongitude() &#123;</span><br><span class="line">return longitude;</span><br><span class="line">&#125;</span><br><span class="line">public Double getLatitude() &#123;</span><br><span class="line">return latitude;</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">public boolean equals(Object that) &#123;</span><br><span class="line">return EqualsBuilder.reflectionEquals(this, that, &quot;id&quot;, &quot;time&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">public int hashCode() &#123;</span><br><span class="line">return HashCodeBuilder.reflectionHashCode(this, &quot;id&quot;, &quot;time&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SpittleController:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package spittr.web;</span><br><span class="line">import java.util.List;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line">import spittr.Spittle;</span><br><span class="line">import spittr.data.SpittleRepository;</span><br><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;/spittles&quot;)</span><br><span class="line">public class SpittleController &#123;</span><br><span class="line">private SpittleRepository spittleRepository;</span><br><span class="line">@Autowired</span><br><span class="line">public SpittleController(//Inject</span><br><span class="line">//SpittleRepository</span><br><span class="line">SpittleRepository spittleRepository) &#123;</span><br><span class="line">this.spittleRepository = spittleRepository;</span><br><span class="line">&#125;</span><br><span class="line">@RequestMapping(method=RequestMethod.GET)</span><br><span class="line">public String spittles(Model model) &#123;</span><br><span class="line">model.addAttribute(//Add spittles to model</span><br><span class="line">spittleRepository.findSpittles(</span><br><span class="line">Long.MAX_VALUE, 20));</span><br><span class="line">return &quot;spittles&quot;;  //Return view name</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>test:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void shouldShowRecentSpittles() throws Exception &#123;</span><br><span class="line">List&lt;Spittle&gt; expectedSpittles = createSpittleList(20);</span><br><span class="line">SpittleRepository mockRepository =  //Mock repository</span><br><span class="line">mock(SpittleRepository.class);</span><br><span class="line">when(mockRepository.findSpittles(Long.MAX_VALUE, 20))</span><br><span class="line">.thenReturn(expectedSpittles);</span><br><span class="line">SpittleController controller =</span><br><span class="line">new SpittleController(mockRepository);</span><br><span class="line">SpittleController controller =</span><br><span class="line">new SpittleController(mockRepository);</span><br><span class="line">MockMvc mockMvc = standaloneSetup(controller)  //Mock Spring MVC</span><br><span class="line">.setSingleView(</span><br><span class="line">new InternalResourceView(&quot;/WEB-INF/views/spittles.jsp&quot;))</span><br><span class="line">.build();</span><br><span class="line">mockMvc.perform(get(&quot;/spittles&quot;))  //GET /spittles</span><br><span class="line">.andExpect(view().name(&quot;spittles&quot;))</span><br><span class="line">.andExpect(model().attributeExists(&quot;spittleList&quot;))</span><br><span class="line">.andExpect(model().attribute(&quot;spittleList&quot;,  //Assert expectations</span><br><span class="line">hasItems(expectedSpittles.toArray())));</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">private List&lt;Spittle&gt; createSpittleList(int count) &#123;</span><br><span class="line">List&lt;Spittle&gt; spittles = new ArrayList&lt;Spittle&gt;();</span><br><span class="line">for (int i=0; i &lt; count; i++) &#123;</span><br><span class="line">spittles.add(new Spittle(&quot;Spittle &quot; + i, new Date()));</span><br><span class="line">&#125;</span><br><span class="line">return spittles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>梳理：<br>通过Spittle来定义单类，定义的SpittleRepository类不实现，然后在测试中通过mock实现，注意when(mockRepository.findSpittles(Long.MAX_VALUE, 20)).thenReturn(expectedSpittles);语句，猜想应该是调用该方法时，直接代理返回expectedSpittles数据，即带Spittle单类的ArrayList。然后添加Assert来对比model中的数据和view中的数据。</p>
<p><strong>Now that there’s data in the model, how does the JSP access it?</strong> As it turns out, when the view is a JSP, the model data is copied into the request as request attributes. Therefore, the spittles.jsp file can use JavaServer Pages Standard Tag Library’s (JSTL) <code>&lt;c:forEach&gt;</code> tag to render the list of spittles:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;c:forEach items=&quot;$&#123;spittleList&#125;&quot; var=&quot;spittle&quot; &gt;</span><br><span class="line">&lt;li id=&quot;spittle_&lt;c:out value=&quot;spittle.id&quot;/&gt;&quot;&gt;</span><br><span class="line">&lt;div class=&quot;spittleMessage&quot;&gt;</span><br><span class="line">&lt;c:out value=&quot;$&#123;spittle.message&#125;&quot; /&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">&lt;span class=&quot;spittleTime&quot;&gt;&lt;c:out value=&quot;$&#123;spittle.time&#125;&quot; /&gt;&lt;/span&gt;</span><br><span class="line">&lt;span class=&quot;spittleLocation&quot;&gt;</span><br><span class="line">(&lt;c:out value=&quot;$&#123;spittle.latitude&#125;&quot; /&gt;,</span><br><span class="line">&lt;c:out value=&quot;$&#123;spittle.longitude&#125;&quot; /&gt;)&lt;/span&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/li&gt;</span><br><span class="line">&lt;/c:forEach&gt;</span><br></pre></td></tr></table></figure>
<p>它的view在brower中显示如下：<br><img src="http://img.blog.csdn.net/20161009201431730" alt=""></p>
<p>One thing that neither HomeController nor SpittleController does, however, is handle any form of input. Let’s expand on SpittleController to <strong>take some input from the client</strong>.</p>
<h3>5.3Accepting request input</h3>

<p>Spring MVC provides several ways that a client can pass data into a controller’s handler method. These include：</p>
<p>1.Query parameters<br>2.Form parameters<br>3.Path variables</p>
<p>For a start, let’s look at handling requests with query parameters, the simplest and most straightforward way to send data from the client to the server.</p>
<h4>5.3.1Taking query parameters</h4>

<p>你想要在前面的基础上，实现翻页的功能，需要加入两个参数：<br>To implement this paging solution, you’ll need to write a handler method that accepts the following:<br>1.A <strong>before</strong> parameter (which indicates the ID of the Spittle that all Spittle objects in the results are before)<br>2.A <strong>count</strong> parameter (which indicates how many spittles to include in the result)</p>
<p>To achieve this, let’s replace the spittles() method you created in listing 5.10 with a new spittles() method that works with the before and count parameters. You’ll start by adding a test to reflect the functionality you want to see from the new spittles() method.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//New method to test for a paged list of spittles</span><br><span class="line">@Test</span><br><span class="line">public void shouldShowPagedSpittles() throws Exception &#123;</span><br><span class="line">List&lt;Spittle&gt; expectedSpittles = createSpittleList(50);</span><br><span class="line">SpittleRepository mockRepository = mock(SpittleRepository.class);</span><br><span class="line">when(mockRepository.findSpittles(238900, 50))  //Expect max and count parameters</span><br><span class="line">.thenReturn(expectedSpittles);</span><br><span class="line">SpittleController controller =</span><br><span class="line">new SpittleController(mockRepository);</span><br><span class="line">MockMvc mockMvc = standaloneSetup(controller)</span><br><span class="line">.setSingleView(</span><br><span class="line">new InternalResourceView(&quot;/WEB-INF/views/spittles.jsp&quot;))</span><br><span class="line">.build();</span><br><span class="line">mockMvc.perform(get(&quot;/spittles?max=238900&amp;count=50&quot;))  //Pass max and count parameters</span><br><span class="line">.andExpect(view().name(&quot;spittles&quot;))</span><br><span class="line">.andExpect(model().attributeExists(&quot;spittleList&quot;))</span><br><span class="line">.andExpect(model().attribute(&quot;spittleList&quot;,</span><br><span class="line">hasItems(expectedSpittles.toArray())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With both tests in place, you can be assured that no matter what changes you make to the controller, it will still be able to handle both kinds of requests:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(method=RequestMethod.GET)</span><br><span class="line">public List&lt;Spittle&gt; spittles(</span><br><span class="line">@RequestParam(&quot;max&quot;) long max,</span><br><span class="line">@RequestParam(&quot;count&quot;) int count) &#123;</span><br><span class="line">return spittleRepository.findSpittles(max, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If the handler method in SpittleController is going to handle requests with or without the max and count parameters, you’ll need to change it to accept those parameters but still default to Long.MAX_VALUE and 20 if those parameters are absent on the request. The defaultValue attribute of @RequestParam will do the trick:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(method=RequestMethod.GET)</span><br><span class="line">public List&lt;Spittle&gt; spittles(</span><br><span class="line">@RequestParam(value=&quot;max&quot;,</span><br><span class="line">defaultValue=MAX_LONG_AS_STRING) long max,</span><br><span class="line">@RequestParam(value=&quot;count&quot;, defaultValue=&quot;20&quot;) int count) &#123;</span><br><span class="line">return spittleRepository.findSpittles(max, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, if the max parameter isn’t specified, it will default to the maximum value of Long. Because query parameters are always of type <strong>String</strong>, the defaultValue attribute requires a <strong>String</strong> value. Therefore, Long.MAX_VALUE won’t work. Instead, you can capture Long.MAX_VALUE in a String constant named MAX_LONG_AS_STRING:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private static final String MAX_LONG_AS_STRING =</span><br><span class="line">Long.toString(Long.MAX_VALUE);</span><br></pre></td></tr></table></figure>
<p>Even though the defaultValue is given as a String, it will be converted to a Long when bound to the method’s max parameter.The count parameter will default to 20 if the request doesn’t have a count parameter.</p>
<p><strong>Query parameters</strong> are a common way to pass information to a controller in a request. Another way that’s popular, especially in a discussion of <strong>building resourceoriented controllers（面向资源的controller）</strong>, is to pass parameters as part of the request path. Let’s see how to use path variables to take input as part of the request path.</p>
<h4>5.3.2Taking input via path parameters</h4>

<p>Let’s say your application needs to support the display of <strong>a single Spittle</strong>, given its ID. One option you have is to write a handler method that accepts the ID as a query parameter using @RequestParam:（一种做法是将ID当做param传入）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=&quot;/show&quot;, method=RequestMethod.GET)</span><br><span class="line">public String showSpittle(</span><br><span class="line">@RequestParam(&quot;spittle_id&quot;) long spittleId,</span><br><span class="line">Model model) &#123;</span><br><span class="line">model.addAttribute(spittleRepository.findOne(spittleId));</span><br><span class="line">return &quot;spittle&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This handler method would handle requests <strong>such as /spittles/show?spittle_id=12345</strong>.虽然没有问题，但是不符合面向资源的controller的套路，Ideally, the resource being identified (the Spittle) would be <strong>identified by the URL path, not by query parameters</strong>. </p>
<p>A GET request for <strong>/spittles/12345</strong> is better than one for <strong>/spittles/show?spittle_id=12345</strong>. <strong>The former identifies a resource to be retrieved</strong>.<strong>The latter describes an operation with a parameter</strong>—essentially RPC over HTTP.</p>
<p>针对面向资源的controller的test（虽然controller现在还没写）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//Testing a request for a Spittle with ID specified in a path variable</span><br><span class="line">@Test</span><br><span class="line">public void testSpittle() throws Exception &#123;</span><br><span class="line">Spittle expectedSpittle = new Spittle(&quot;Hello&quot;, new Date());</span><br><span class="line">SpittleRepository mockRepository = mock(SpittleRepository.class);</span><br><span class="line">when(mockRepository.findOne(12345)).thenReturn(expectedSpittle);</span><br><span class="line">SpittleController controller = new SpittleController(mockRepository);</span><br><span class="line">MockMvc mockMvc = standaloneSetup(controller).build();</span><br><span class="line">mockMvc.perform(get(&quot;/spittles/12345&quot;))  //Request resource via path</span><br><span class="line">.andExpect(view().name(&quot;spittle&quot;))</span><br><span class="line">.andExpect(model().attributeExists(&quot;spittle&quot;))</span><br><span class="line">.andExpect(model().attribute(&quot;spittle&quot;, expectedSpittle));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了迎合上面的测试，必须拿到12345这个值啊。<br>To accommodate these path variables, Spring MVC allows for placeholders in an @RequestMapping path. The placeholders are names surrounded by curly braces ({ and }). <strong>Although all the other parts of the path need to match exactly for the request to be handled, the placeholder can carry any value.（request的其他部分必须精确匹配，placeholder中可以存放任意值）</strong>Here’s a handler method that uses placeholders to accept a Spittle ID as part of<br>the path:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=&quot;/&#123;spittleId&#125;&quot;, method=RequestMethod.GET)</span><br><span class="line">public String spittle(</span><br><span class="line">@PathVariable(&quot;spittleId&quot;) long spittleId,</span><br><span class="line">Model model) &#123;</span><br><span class="line">model.addAttribute(spittleRepository.findOne(spittleId));</span><br><span class="line">return &quot;spittle&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For example, it can handle requests for /spittles/12345.If the request is a GET request for /spittles/54321, then 54321 will be passed in as the value of spittleId.</p>
<p><strong>严重怀疑上面代码的正确性，是否应该将value=”/{spittleId}”改为value=”/spittles/{spittleId}”?</strong></p>
<p>Query parameters and path parameters <strong>are fine for passing small amounts of data</strong> on a request. But often you need to pass a lot of data (perhaps data coming from a form submission), and query parameters are too awkward and limited for that. Let’s see how you can write controller methods that handle form submissions.</p>
<h3>5.4Processing forms</h3>

<p>There are two sides to working with forms: 1.displaying the form and 2.processing the data the user submits from the form.<br><strong>SpitterController</strong> is a new controller with a single request-handling method for displaying the registration form.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//SpitterController: displays a form for users to sign up with the app</span><br><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;/spitter&quot;)</span><br><span class="line">public class SpitterController &#123;</span><br><span class="line">@RequestMapping(value=&quot;/register&quot;, method=GET)//Handle GET requestsfor /spitter/register</span><br><span class="line">public String showRegistrationForm() &#123;</span><br><span class="line">return &quot;registerForm&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Given how you’ve configured InternalResourceViewResolver, that means the JSP at /WEB INF/views/registerForm.jsp will be called on to render the registration form.</p>
<p>测试也非常简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//Testing a form-displaying controller method</span><br><span class="line">@Test</span><br><span class="line">public void shouldShowRegistration() throws Exception &#123;</span><br><span class="line">SpitterController controller = new SpitterController();</span><br><span class="line">MockMvc mockMvc = standaloneSetup(controller).build();  //Set up MockMvc</span><br><span class="line">mockMvc.perform(get(&quot;/spitter/register&quot;))</span><br><span class="line">.andExpect(view().name(&quot;registerForm&quot;));  //Assert registerForm view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的jsp也非常的simple：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//JSP to render a registration form</span><br><span class="line">&lt;%@ taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot; %&gt;</span><br><span class="line">&lt;%@ page session=&quot;false&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Spittr&lt;/title&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot;</span><br><span class="line">href=&quot;&lt;c:url value=&quot;/resources/style.css&quot; /&gt;&quot; &gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Register&lt;/h1&gt;</span><br><span class="line">&lt;form method=&quot;POST&quot;&gt;</span><br><span class="line">First Name: &lt;input type=&quot;text&quot; name=&quot;firstName&quot; /&gt;&lt;br/&gt;</span><br><span class="line">Last Name: &lt;input type=&quot;text&quot; name=&quot;lastName&quot; /&gt;&lt;br/&gt;</span><br><span class="line">Username: &lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt;&lt;br/&gt;</span><br><span class="line">Password: &lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;&lt;br/&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; value=&quot;Register&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>Notice that the <code>&lt;form&gt;</code> tag <strong>doesn’t have an action parameter set</strong>. Because of that, when this form is submitted, it will be <strong>posted back to the same URL path that displayed it</strong>. That is, it will be posted back to /spitters/register.That means you’ll need something back on the server to <strong>handle the HTTP POST request</strong>. Let’s add another method to SpitterController to handle form submission.</p>
<h4>5.4.1Writing a form-handling controller</h4>

<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void shouldProcessRegistration() throws Exception &#123;</span><br><span class="line">SpitterRepository mockRepository =</span><br><span class="line">mock(SpitterRepository.class);  //Set up mock repository</span><br><span class="line">Spitter unsaved =</span><br><span class="line">new Spitter(&quot;jbauer&quot;, &quot;24hours&quot;, &quot;Jack&quot;, &quot;Bauer&quot;);</span><br><span class="line">Spitter saved =</span><br><span class="line">new Spitter(24L, &quot;jbauer&quot;, &quot;24hours&quot;, &quot;Jack&quot;, &quot;Bauer&quot;);</span><br><span class="line">when(mockRepository.save(unsaved)).thenReturn(saved);</span><br><span class="line">SpitterController controller =</span><br><span class="line">new SpitterController(mockRepository);</span><br><span class="line">MockMvc mockMvc = standaloneSetup(controller).build(); //Set up MockMvc</span><br><span class="line">mockMvc.perform(post(&quot;/spitter/register&quot;)  //Perform request</span><br><span class="line">.param(&quot;firstName&quot;, &quot;Jack&quot;)</span><br><span class="line">.param(&quot;lastName&quot;, &quot;Bauer&quot;)</span><br><span class="line">.param(&quot;username&quot;, &quot;jbauer&quot;)</span><br><span class="line">.param(&quot;password&quot;, &quot;24hours&quot;))</span><br><span class="line">.andExpect(redirectedUrl(&quot;/spitter/jbauer&quot;));</span><br><span class="line">verify(mockRepository, atLeastOnce()).save(unsaved);  //Verify save</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When handling a POST request, it’s usually a good idea to send a redirect after the POST has completed processing so that a browser refresh won’t accidentally submit the form a second time. This test expects that the request will end in a redirect to /spitter/jbauer, the URL path of the new user’s profile page.（<strong>处理POST请求，一般加上重定向，避免刷新后重新提交</strong>）</p>
<p>正经的加上功能：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//Handling form submission to register a new user</span><br><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;/spitter&quot;)</span><br><span class="line">public class SpitterController &#123;</span><br><span class="line">private SpitterRepository spitterRepository;</span><br><span class="line">@Autowired</span><br><span class="line">public SpitterController(</span><br><span class="line">SpitterRepository spitterRepository) &#123;  //Inject SpitterRepository</span><br><span class="line">this.spitterRepository = spitterRepository;</span><br><span class="line">&#125;</span><br><span class="line">@RequestMapping(value=&quot;/register&quot;, method=GET)</span><br><span class="line">public String showRegistrationForm() &#123;</span><br><span class="line">return &quot;registerForm&quot;;</span><br><span class="line">&#125;</span><br><span class="line">@RequestMapping(value=&quot;/register&quot;, method=POST)</span><br><span class="line">public String processRegistration(Spitter spitter) &#123;</span><br><span class="line">spitterRepository.save(spitter);  //Save a Spitter</span><br><span class="line">return &quot;redirect:/spitter/&quot; +  //Redirect to profile page</span><br><span class="line">spitter.getUsername();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Notice the new <strong>processRegistration()</strong> method: <strong>it’s given a Spitter object as a parameter</strong>. This object has firstName, lastName, username, and password properties that will be populated from the request parameters of the same name.</p>
<p>When InternalResourceViewResolver sees the <strong>redirect</strong>: prefix on the view specification, it knows to <strong>interpret it as a redirect specification instead of as a view name</strong>. In this case, it will redirect to the path for a user’s profile page. For example, if the Spitter.username property is jbauer, then the view will redirect to /spitter/jbauer.</p>
<p>It’s worth noting that in addition to redirect:, InternalResourceViewResolver also recognizes the <strong>forward:</strong> prefix. When it sees a view specification prefixed with forward:, the request is forwarded to the given URL path instead of redirected.</p>
<p><strong>疑问：搞不懂processRegistration方法中的参数Spitter是怎么传入的。</strong>，form表单中也没有标注啊。</p>
<p>What will happen if the form doesn’t send a username or password parameter? Or what if the firstName or lastName value is empty or too long? Let’s look at how to add validation to the form submission to prevent inconsistencies in the data presented.</p>
<h4>5.4.2Validating forms</h4>

<p>除了在controller的逻辑中判断是否合法，<strong>The Java Validation API</strong> defines several annotations that you can put on properties to place constraints on the values of those properties. All of these annotations are in the javax.validation.constraints package. Table 5.1 lists these validation annotations.<br><img src="http://img.blog.csdn.net/20161009220654575" alt=""><br><img src="http://img.blog.csdn.net/20161009220727741" alt=""></p>
<p>Thinking over the constraints you need to apply to the fields in Spitter, it seems you’ll probably need the @NotNull and @Size annotations. All you need to do is <strong>toss those annotations around on the properties of Spitter</strong>. The next listing shows Spitter with its properties annotated for validation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//在单类Spitter中进行限定</span><br><span class="line">public class Spitter &#123;</span><br><span class="line">private Long id;</span><br><span class="line">@NotNull</span><br><span class="line">@Size(min=5, max=16)</span><br><span class="line">private String username;</span><br><span class="line">@NotNull</span><br><span class="line">@Size(min=5, max=25)</span><br><span class="line">private String password;</span><br><span class="line">@NotNull</span><br><span class="line">@Size(min=2, max=30)</span><br><span class="line">private String firstName;</span><br><span class="line">@NotNull</span><br><span class="line">@Size(min=2, max=30)</span><br><span class="line">private String lastName;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now that you have annotated Spitter with validation constraints, you need to <strong>change the processRegistration() method to apply validation</strong>. The new validationenabled processRegistration() is shown next.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//processRegistration(): ensures that data submitted is valid</span><br><span class="line">@RequestMapping(value=&quot;/register&quot;, method=POST)</span><br><span class="line">public String processRegistration(</span><br><span class="line">@Valid Spitter spitter,  //Validate Spitter input,加入了@Valid</span><br><span class="line">Errors errors) &#123;</span><br><span class="line">if (errors.hasErrors()) &#123;</span><br><span class="line">return &quot;registerForm&quot;;  //Return to form on validation errors</span><br><span class="line">&#125;</span><br><span class="line">spitterRepository.save(spitter);</span><br><span class="line">return &quot;redirect:/spitter/&quot; + spitter.getUsername();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>5.5Summary</h3>

<p>Coming up in chapter 6, we’ll dig deeper into Spring views, expanding on how you can take advantage of Spring tag libraries in JSP. You’ll also see how to add consistent layouts to your views using Apache Tiles. And we’ll look at <strong>Thymeleaf</strong>, <strong>an exciting alternative to JSP that comes with built-in Spring support</strong>.</p>
<h1>Chapter6.Rendering web views</h1>

<p>Last chapter,we didn’t spend too much time discussing the views or what happens between the time a controller finishes handling a request and the time the results are displayed in the user’s web browser. That’s the topic of this chapter.</p>
<h3>6.1Understanding view resolution</h3>

<p>But if the controller only knows about the view by a logical view name, how does Spring determine which actual view implementation it should use to render the model? That’s a job for <strong>Spring’s view resolvers</strong>.</p>
<p>Spring给你实现的各种view resolver：<br>Spring comes with 13 view resolvers <strong>to translate logical view names into physical view implementations</strong>.<br><img src="http://img.blog.csdn.net/20161010102136038" alt=""></p>
<p>For the most part, each of the view resolvers in table 6.1 corresponds to a specific view technology available for Java web applications. </p>
<p><strong>InternalResourceViewResolver</strong> is typically used for <strong>JSP</strong>, <strong>TilesViewResolver</strong> is for <strong>Apache Tiles views</strong>, and <strong>FreeMarkerViewResolver</strong> and <strong>VelocityViewResolver</strong> map to <strong>FreeMarker</strong> and <strong>Velocity</strong> template views respectively.</p>
<p>To wrap up this chapter, we’ll look at a view-resolver option that isn’t listed in table 6.1. Thymeleaf is a compelling alternative to JSP that offers a view resolver for working with Thymeleaf’s natural templates: templates that have more in common with the HTML they produce than with the Java code that drives them. Thymeleaf is such an exciting view option that I wouldn’t blame you if you flipped a few pages ahead to section 6.4 to see how to use it with Spring.<br><strong>Thymeleaf大法好啊！</strong></p>
<h3>6.2Creating JSP views</h3>

<p>Spring supports JSP views in two ways:</p>
<p>1.<strong>InternalResourceViewResolver</strong> can be used to resolve view names into JSP files. Moreover, if you’re using JavaServer Pages Standard Tag Library (JSTL)<br>tags in your JSP pages, InternalResourceViewResolver can resolve view names into JSP files fronted by JstlView to expose JSTL locale and resource bundle<br>variables to JSTL’s formatting and message tags.</p>
<p>2.Spring provides two JSP tag libraries, one for form-to-model binding and one providing general utility features.</p>
<h4>6.2.1Configuring a JSP-ready view resolver</h4>

<p><img src="http://img.blog.csdn.net/20161010103654620" alt=""></p>
<p>You can configure InternalResourceViewResolver to apply this convention when resolving views by configuring it with this @Bean-annotated method:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public ViewResolver viewResolver() &#123;</span><br><span class="line">InternalResourceViewResolver resolver =</span><br><span class="line">new InternalResourceViewResolver();</span><br><span class="line">resolver.setPrefix(&quot;/WEB-INF/views/&quot;);</span><br><span class="line">resolver.setSuffix(&quot;.jsp&quot;);</span><br><span class="line">return resolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>RESOLVING JSTL VIEWS</strong></p>
<p> If those JSP files are using <strong>JSTL tags</strong> for formatting or messages, then you may want to configure InternalResourceViewResolver to resolve a JstlView instead.配置如下，与上面差不多：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public ViewResolver viewResolver() &#123;</span><br><span class="line">InternalResourceViewResolver resolver =</span><br><span class="line">new InternalResourceViewResolver();</span><br><span class="line">resolver.setPrefix(&quot;/WEB-INF/views/&quot;);</span><br><span class="line">resolver.setSuffix(&quot;.jsp&quot;);</span><br><span class="line">resolver.setViewClass(</span><br><span class="line">org.springframework.web.servlet.view.JstlView.class);</span><br><span class="line">return resolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4>6.2.2Using Spring’s JSP libraries</h4>

<p>Spring offers <strong>two JSP tag libraries</strong> to help define the view of your Spring MVC web views. One tag library <strong>1.renders HTML form tags that are bound to a model attribute</strong>. The other has <strong>2.a hodgepodge of utility tags</strong> that come in handy from time to time.</p>
<p>You’re likely to find the <strong>form-binding tag library</strong> to be the more useful of the two tag libraries. </p>
<p><strong>BINDING FORMS TO THE MODEL</strong></p>
<p>Spring’s form-binding JSP tag library includes 14 tags, most of which render HTML form tags. But what makes these different from the raw HTML tags is that they’re bound to an object in the model and can be populated with values from the model object’s properties. The tag library also includes a tag that can be used to communicate errors to the user by rendering them into the resulting HTML.跟HTML tag差不多，但它携带了model数据。</p>
<p>1.To use the form-binding tag library, you’ll need to <strong>declare it in the JSP pages</strong> that will use it:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib uri=&quot;http://www.springframework.org/tags/form&quot; prefix=&quot;sf&quot; %&gt;</span><br></pre></td></tr></table></figure>
<p>Notice that I specified a prefix of <strong>sf</strong>, but it’s also common to use a prefix of <strong>form</strong>. 没什么别的含义。<br><img src="http://img.blog.csdn.net/20161010105750385" alt=""><br>Applying those tags to the registration JSP, you get the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;sf:form method=&quot;POST&quot; commandName=&quot;spitter&quot;&gt;</span><br><span class="line">First Name: &lt;sf:input path=&quot;firstName&quot; /&gt;&lt;br/&gt;</span><br><span class="line">Last Name: &lt;sf:input path=&quot;lastName&quot; /&gt;&lt;br/&gt;</span><br><span class="line">Email: &lt;sf:input path=&quot;email&quot; /&gt;&lt;br/&gt;</span><br><span class="line">Username: &lt;sf:input path=&quot;username&quot; /&gt;&lt;br/&gt;</span><br><span class="line">Password: &lt;sf:password path=&quot;password&quot; /&gt;&lt;br/&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; value=&quot;Register&quot; /&gt;</span><br><span class="line">&lt;/sf:form&gt;</span><br></pre></td></tr></table></figure>
<p>In the preceding code, you set commandName to spitter. Therefore, there must be an object in the model whose key is spitter, or else the form won’t be able to render (and you’ll get JSP errors). That means you need to make a small change to SpitterController to ensure that a Spitter object is in the model under the spitter key:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=&quot;/register&quot;, method=GET)</span><br><span class="line">public String showRegistrationForm(Model model) &#123;</span><br><span class="line">model.addAttribute(new Spitter());</span><br><span class="line">return &quot;registerForm&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Using Spring’s form-binding tags gives you a slight improvement over using standard HTML tags—<strong>the form is prepopulated with the previously entered values after failed validation</strong>. But it still fails to tell the user what they did wrong. To guide the user in fixing their mistakes, you’ll need the <code>&lt;sf:errors&gt;</code> tag.</p>
<p><strong>DISPLAYING ERRORS</strong></p>
<h3>6.3Defining a layout with Apache Tiles views</h3>

<h3>6.4Working with Thymeleaf</h3>

<p>The most recent contender, <strong>Thymeleaf</strong>, shows<br>some real promise and is an exciting choice to consider. Thymeleaf templates are natural and don’t rely on tag libraries. They can be edited and rendered anywhere that raw HTML is welcome. And because they’re not coupled to the servlet specification,<br>Thymeleaf templates can go places JSPs dare not tread. Let’s look at how to use Thymeleaf with Spring MVC.终于要用这一大杀器了！</p>
<h4>6.4.1Configuring a Thymeleaf view resolver</h4>

<p>In order to use Thymeleaf with Spring, you’ll need to <strong>configure three beans</strong> that enable Thymeleaf-Spring integration:</p>
<p>1.A <strong>ThymeleafViewResolver</strong> that resolves Thymeleaf template views from logical view names<br>2.A <strong>SpringTemplateEngine</strong> to process the templates and render the results<br>3.A <strong>TemplateResolver</strong> that loads Thymeleaf templates</p>
<p>java配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public ViewResolver viewResolver(//Thymeleaf //view resolver</span><br><span class="line">SpringTemplateEngine templateEngine) &#123;</span><br><span class="line">ThymeleafViewResolver viewResolver = new ThymeleafViewResolver();</span><br><span class="line">viewResolver.setTemplateEngine(templateEngine);</span><br><span class="line">return viewResolver;</span><br><span class="line">&#125;</span><br><span class="line">@Bean</span><br><span class="line">public TemplateEngine templateEngine(//Template //engine</span><br><span class="line">TemplateResolver templateResolver) &#123;</span><br><span class="line">SpringTemplateEngine templateEngine = new SpringTemplateEngine();</span><br><span class="line">templateEngine.setTemplateResolver(templateResolver);</span><br><span class="line">return templateEngine;</span><br><span class="line">&#125;</span><br><span class="line">@Bean</span><br><span class="line">public TemplateResolver templateResolver() &#123;</span><br><span class="line">//Template resolver</span><br><span class="line">TemplateResolver templateResolver =</span><br><span class="line">new ServletContextTemplateResolver();</span><br><span class="line">templateResolver.setPrefix(&quot;/WEB-INF/templates/&quot;);</span><br><span class="line">templateResolver.setSuffix(&quot;.html&quot;);</span><br><span class="line">templateResolver.setTemplateMode(&quot;HTML5&quot;);</span><br><span class="line">return templateResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ThymeleafViewResolver</strong> is an implementation of Spring MVC’s ViewResolver. Just like any view resolver, it takes a logical view name and resolves a view. But <strong>in this case, that view is ultimately a Thymeleaf template</strong>.</p>
<h4>6.4.2Defining Thymeleaf templates</h4>

<p>Thymeleaf templates are primarily just HTML files.What makes Thymeleaf tick, however, is that it <strong>adds Thymeleaf attributes</strong> to the standard set of HTML tags via a custom namespace.</p>
<p>下面是home.html：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//home.html: home page template using the //Thymeleaf namespace</span><br><span class="line">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;</span><br><span class="line">xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;//Declare //Thymeleaf namespace</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Spittr&lt;/title&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot;</span><br><span class="line">type=&quot;text/css&quot;</span><br><span class="line">th:href=&quot;@&#123;/resources/style.css&#125;&quot;&gt;&lt;/link&gt;//th:href link to stylesheet</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to Spittr&lt;/h1&gt;</span><br><span class="line">//th:href link to stylesheet</span><br><span class="line">&lt;a th:href=&quot;@&#123;/spittles&#125;&quot;&gt;Spittles&lt;/a&gt; |</span><br><span class="line">&lt;a th:href=&quot;@&#123;/spitter/register&#125;&quot;&gt;Register&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>What makes th:href special is that its value can contain <strong>Thymeleaf expressions</strong> to evaluate dynamic values. It will render a standard href attribute containing a value that’s dynamically created at render time. This is how many of the attributes in the Thymeleaf namespace work: <strong>they mirror the standard HTML attribute that they share a name with, to render some computed value</strong>. </p>
<p>In this case, all three uses of the th:href attribute use the <strong>@{} expressions</strong> to calculate context-sensitive URL paths (much as you might use JSTL’s <code>&lt;c:url&gt;</code> tag or Spring’s <code>&lt;s:url&gt;</code> tag in a JSP page).</p>
<p>This means Thymeleaf templates, unlike JSPs, can be edited and even rendered naturally, without going through any sort of processor.Sure, you’ll need Thymeleaf to process the templates to fully render the desired output. </p>
<p>Simple templates like home.html are a nice introduction to Thymeleaf. But form binding is something that Spring’s JSP tags excel at. If you’re abandoning JSP, must you abandon form binding as well? Fear not. Thymeleaf has a little something up its<br>sleeve.</p>
<p><strong>FORM BINDING WITH THYMELEAF</strong></p>
<p>Form binding is an important feature of Spring MVC. It makes it possible for controllers to receive command objects populated with data submitted in a form and for the form to be prepopulated with values from the command object when displaying the form. </p>
<p>Without proper form binding, you’d have to ensure that 1.the HTML form fields were properly named to map to the backing command object’s properties. And you’d also be responsible for 2.ensuring that the fields’ values were set to the command object’s properties when redisplaying a form after validation failure.</p>
<p>To demonstrate Thymeleaf data binding in action, the following listing shows the complete registration form template.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">//Registration page, using Thymeleaf to bind a //form to a command object</span><br><span class="line">&lt;form method=&quot;POST&quot; th:object=&quot;$&#123;spitter&#125;&quot;&gt;</span><br><span class="line">&lt;div class=&quot;errors&quot;  //Display errors</span><br><span class="line">th:if=&quot;$&#123;#fields.hasErrors(&apos;*&apos;)&#125;&quot;&gt;</span><br><span class="line">&lt;ul&gt;</span><br><span class="line">&lt;li th:each=&quot;err : $&#123;#fields.errors(&apos;*&apos;)&#125;&quot;</span><br><span class="line">th:text=&quot;$&#123;err&#125;&quot;&gt;Input is incorrect&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;label th:class=&quot;$&#123;#fields.hasErrors(&apos;firstName&apos;)&#125;? &apos;error&apos;&quot;&gt;</span><br><span class="line">First Name&lt;/label&gt;:</span><br><span class="line">&lt;input type=&quot;text&quot; th:field=&quot;*&#123;firstName&#125;&quot;</span><br><span class="line">th:class=&quot;$&#123;#fields.hasErrors(&apos;firstName&apos;)&#125;? &apos;error&apos;&quot; /&gt;&lt;br/&gt;</span><br><span class="line">&lt;label th:class=&quot;$&#123;#fields.hasErrors(&apos;lastName&apos;)&#125;? &apos;error&apos;&quot;&gt;</span><br><span class="line">Last Name&lt;/label&gt;:</span><br><span class="line">&lt;input type=&quot;text&quot; th:field=&quot;*&#123;lastName&#125;&quot;</span><br><span class="line">th:class=&quot;$&#123;#fields.hasErrors(&apos;lastName&apos;)&#125;? &apos;error&apos;&quot; /&gt;&lt;br/&gt;</span><br><span class="line">&lt;label th:class=&quot;$&#123;#fields.hasErrors(&apos;email&apos;)&#125;? &apos;error&apos;&quot;&gt;</span><br><span class="line">Email&lt;/label&gt;:</span><br><span class="line">&lt;input type=&quot;text&quot; th:field=&quot;*&#123;email&#125;&quot;</span><br><span class="line">th:class=&quot;$&#123;#fields.hasErrors(&apos;email&apos;)&#125;? &apos;error&apos;&quot; /&gt;&lt;br/&gt;</span><br><span class="line">&lt;label th:class=&quot;$&#123;#fields.hasErrors(&apos;username&apos;)&#125;? &apos;error&apos;&quot;&gt;</span><br><span class="line">Username&lt;/label&gt;:</span><br><span class="line">&lt;input type=&quot;text&quot; th:field=&quot;*&#123;username&#125;&quot;</span><br><span class="line">th:class=&quot;$&#123;#fields.hasErrors(&apos;username&apos;)&#125;? &apos;error&apos;&quot; /&gt;&lt;br/&gt;</span><br><span class="line">&lt;label th:class=&quot;$&#123;#fields.hasErrors(&apos;password&apos;)&#125;? &apos;error&apos;&quot;&gt;</span><br><span class="line">Password&lt;/label&gt;:</span><br><span class="line">&lt;input type=&quot;password&quot; th:field=&quot;*&#123;password&#125;&quot;</span><br><span class="line">th:class=&quot;$&#123;#fields.hasErrors(&apos;password&apos;)&#125;? &apos;error&apos;&quot; /&gt;&lt;br/&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; value=&quot;Register&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure></p>
<p>You may be wondering about the difference between the expressions wrapped with <code>${}</code> and those wrapped with <code>*{}</code>. The <code>${}</code> expressions (such as <code>${spitter}</code>) are variable expressions. In the case of <code>${spitter}</code>, it resolves to the model property whose key is spitter.</p>
<p>As for <code>*{}</code> expressions, they’re selection expressions.In the case of the form, the selected object is the one given in the <code>&lt;form&gt;</code> tag’s <code>th:object</code> attribute: a Spitter object from the model. Therefore the <code>*{firstName}</code> expression evaluates to the firstName property on the Spitter object.</p>
<h3>6.5Summary</h3>

<h1>Chapter7.Advanced Spring MVC</h1>

<p>In chapter 5, we looked at essential Spring MVC and how to write controllers to handle various kinds of requests. Then you built on that in chapter 6 to create the JSP and Thymeleaf views that present model data to the user. You might think you know everything about Spring MVC. But wait! There’s more!</p>
<h3>7.1Alternate Spring MVC configuration</h3>

<h4>7.1.1Customizing DispatcherServlet configuration</h4><br><h4>7.1.2Adding additional servlets and filters</h4><br><h4>7.1.3 Declaring DispatcherServlet in web.xml</h4>

<h3>7.2Processing multipart form data</h3>

<p>The Spittr application calls for file uploads in two places. When a new user registers with the application, you’d like them to be able to provide a picture to associate with their profile. And when a user posts a new Spittle, they may want to upload a photo to go along with their message.</p>
<p>Typical form fields have textual data in their parts, but when something is being uploaded, the part can be binary, as shown in the following multipart request body:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span><br><span class="line">Content-Disposition: form-data; name=&quot;username&quot;</span><br><span class="line">professorx</span><br><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span><br><span class="line">Content-Disposition: form-data; name=&quot;password&quot;</span><br><span class="line">letmein01</span><br><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW</span><br><span class="line">Content-Disposition: form-data; name=&quot;profilePicture&quot;; filename=&quot;me.jpg&quot;</span><br><span class="line">Content-Type: image/jpeg</span><br><span class="line">[[ Binary image data goes here ]]</span><br><span class="line">------WebKitFormBoundaryqgkaBn8IHJCuNmiW--</span><br></pre></td></tr></table></figure>
<p>Even though multipart requests look complex, handling them in a Spring MVC controller is easy. But before you can write controller methods to handle file uploads, you must <strong>configure a multipart resolver</strong> to <strong>tell DispatcherServlet how to read multipart requests</strong>.第一步</p>
<h4>7.2.1Configuring a multipart resolver</h4>

<p><strong>DispatcherServlet</strong> doesn’t implement any logic for parsing the data in a multipart request. Instead, it delegates to an implementation of Spring’s <strong>MultipartResolver</strong> strategy interface to resolve the content in a multipart request. Since Spring 3.1,<br>Spring comes with two out-of-the-box implementations of MultipartResolver to<br>choose from:</p>
<p>1.<strong>CommonsMultipartResolver</strong>—Resolves multipart requests using Jakarta Commons FileUpload<br>2.<strong>StandardServletMultipartResolver</strong>—Relies on Servlet 3.0 support for multipart requests (since Spring 3.1)</p>
<p>Generally speaking, <strong>StandardServletMultipartResolver</strong> should probably be your <strong>first choice of these two</strong>.</p>
<p><strong>RESOLVING MULTIPART REQUESTS WITH SERVLET 3.0</strong></p>
<p>It’s extremely simple to declare StandardServletMultipartResolver as a bean in your Spring configuration, as shown here:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public MultipartResolver multipartResolver() throws IOException &#123;</span><br><span class="line">return new StandardServletMultipartResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>As easy as that @Bean method is, you might be wondering how you can <strong>place constraints</strong> on the way StandardServletMultipartResolver works.What if you want to limit the maximum size of file that a user can upload? Or what if you’d like to specify the location where the uploaded files are temporarily written while they’re being uploaded?</p>
<p>没有properties和constructor arguments，StandardServletMultipartResolver好像没有办法，那就在DispatcherServlet中配置咯。</p>
<p>If you’re configuring DispatcherServlet in a servlet initializer class that implements <strong>WebApplicationInitializer</strong>, you can configure multipart details by calling <strong>setMultipartConfig()</strong> on the servlet registration, passing an instance of MultipartConfigElement. Here’s a minimal multipart configuration for DispatcherServlet that sets the temporary location to /tmp/spittr/uploads:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DispatcherServlet ds = new DispatcherServlet();</span><br><span class="line">Dynamic registration = context.addServlet(&quot;appServlet&quot;, ds);</span><br><span class="line">registration.addMapping(&quot;/&quot;);</span><br><span class="line">registration.setMultipartConfig(</span><br><span class="line">new MultipartConfigElement(&quot;/tmp/spittr/uploads&quot;));</span><br></pre></td></tr></table></figure>
<p>If you’ve configured DispatcherServlet in a servlet initializer class that extends <strong>AbstractAnnotationConfigDispatcherServletInitializer</strong> or <strong>AbstractDispatcherServletInitializer</strong>, you don’t create the instance of DispatcherServlet or register it with the servlet context directly.<br>Consequently, there’s no handy reference to the<br>Dynamic servlet registration to work with. But you can <strong>override the customizeRegistration() method</strong> (which is given a Dynamic as a parameter) to configure multipart details:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void customizeRegistration(Dynamic registration) &#123;</span><br><span class="line">registration.setMultipartConfig(</span><br><span class="line">new MultipartConfigElement(&quot;/tmp/spittr/uploads&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In addition to the temporary location path, the other constructor accepts the following，其他的构造方法：<br>1.The maximum size (in bytes) of <strong>any file uploaded</strong>. By default there is no limit.<br>2.The maximum size (in bytes) of the <strong>entire multipart request</strong>, regardless of how many parts or how big any of the parts are. By default there is no limit.<br>3.The maximum size (in bytes) of a file that can be uploaded without being written to the temporary location. The default is 0, meaning that all uploaded files will be written to disk.</p>
<p>For example, suppose you want to limit files to no more than 2 MB, to limit the entire request to no more than 4 MB, and to write all files to disk. The following use of MultipartConfigElement sets those thresholds:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void customizeRegistration(Dynamic registration) &#123;</span><br><span class="line">registration.setMultipartConfig(</span><br><span class="line">new MultipartConfigElement(&quot;/tmp/spittr/uploads&quot;,</span><br><span class="line">2097152, 4194304, 0));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>7.2Handling multipart requests</h3>

<p>The following snippet from the Thymeleaf registration form view (registrationForm.html) highlights the necessary changes to the form:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;form method=&quot;POST&quot; th:object=&quot;$&#123;spitter&#125;&quot;</span><br><span class="line">enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">...</span><br><span class="line">&lt;label&gt;Profile Picture&lt;/label&gt;:</span><br><span class="line">&lt;input type=&quot;file&quot;</span><br><span class="line">name=&quot;profilePicture&quot;</span><br><span class="line">accept=&quot;image/jpeg,image/png,image/gif&quot; /&gt;&lt;br/&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure></p>
<p>The <code>&lt;form&gt;</code> tag now has its enctype attribute set to <strong>multipart/form-data</strong>. This tells the browser to submit the form as multipart data instead of form data. Each field has its own part in the multipart request.<br>In addition to all the existing fields on the registration form, you’ve added a new <strong><input></strong> field whose type is file. This lets the user select an image file to upload. The accept attribute is set to limit file types to JPEG, PNG, and GIF images. And according to its name attribute, the image data will be sent <strong>in the multipart request in the profilePicture part</strong>.</p>
<p>Now you just need to change the <strong>processRegistration()</strong> method to accept the<br>uploaded image. One way to do that is to add a byte array parameter that’s annotated with <strong>@RequestPart</strong>. Here’s an example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=&quot;/register&quot;, method=POST)</span><br><span class="line">public String processRegistration(</span><br><span class="line">@RequestPart(&quot;profilePicture&quot;) byte[] profilePicture,</span><br><span class="line">@Valid Spitter spitter,</span><br><span class="line">Errors errors) &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>RECEIVING A MULTIPARTFILE</strong></p>
<p>不再只得到byte[]数据，将得到更完善的文件信息。需要将<br>@RequestPart(“profilePicture”) byte[] profilePicture,改为@RequestPart(“profilePicture”)  MultipartFile profilePicture,这应该是很显然的嘛。</p>
<p>Working with the uploaded file’s raw bytes is simple but limiting. Therefore, Spring also offers <strong>MultipartFile</strong> as a way to get a richer object for processing multipart data. The following listing shows what the MultipartFile interface looks like.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//Spring’s MultipartFile interface for working //with uploaded files</span><br><span class="line">public interface MultipartFile &#123;</span><br><span class="line">String getName();</span><br><span class="line">String getOriginalFilename();</span><br><span class="line">String getContentType();</span><br><span class="line">boolean isEmpty();</span><br><span class="line">long getSize();</span><br><span class="line">byte[] getBytes() throws IOException;</span><br><span class="line">InputStream getInputStream() throws IOException;</span><br><span class="line">void transferTo(File dest) throws IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For example, you could add the following lines to processRegistration() to write the uploaded image file to the filesystem:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">profilePicture.transferTo(</span><br><span class="line">new File(&quot;/data/spittr/&quot; + profilePicture.getOriginalFilename()));</span><br></pre></td></tr></table></figure></p>
<p><strong>SAVING FILES TO AMAZON S3</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//Saving a MultipartFile to Amazon S3</span><br><span class="line">private void saveImage(MultipartFile image)</span><br><span class="line">throws ImageUploadException &#123;</span><br><span class="line">try &#123;</span><br><span class="line">AWSCredentials awsCredentials =</span><br><span class="line">new AWSCredentials(s3AccessKey, s2SecretKey);</span><br><span class="line">//Set up S3 service</span><br><span class="line">S3Service s3 = new RestS3Service(awsCredentials);</span><br><span class="line">//Create S3 bucket and object</span><br><span class="line">S3Bucket bucket = s3.getBucket(&quot;spittrImages&quot;);</span><br><span class="line">S3Object imageObject =</span><br><span class="line">new S3Object(image.getOriginalFilename());</span><br><span class="line">//Set image data</span><br><span class="line">imageObject.setDataInputStream(</span><br><span class="line">image.getInputStream());</span><br><span class="line">imageObject.setContentLength(image.getSize());</span><br><span class="line">imageObject.setContentType(image.getContentType());</span><br><span class="line">//Set permissions</span><br><span class="line">AccessControlList acl = new AccessControlList();</span><br><span class="line">acl.setOwner(bucket.getOwner());</span><br><span class="line">acl.grantPermission(GroupGrantee.ALL_USERS,</span><br><span class="line">Permission.PERMISSION_READ);</span><br><span class="line">imageObject.setAcl(acl);</span><br><span class="line">//Save image</span><br><span class="line">s3.putObject(bucket, imageObject);</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">throw new ImageUploadException(&quot;Unable to save image&quot;, e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>RECEIVING THE UPLOADED FILE AS A PART</strong><br>If you’re deploying your application to a Servlet 3.0 container, you have an alternative to MultipartFile.</p>
<p>改动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=&quot;/register&quot;, method=POST)</span><br><span class="line">public String processRegistration(</span><br><span class="line">@RequestPart(&quot;profilePicture&quot;) Part profilePicture,</span><br><span class="line">@Valid Spitter spitter,</span><br><span class="line">Errors errors) &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see in the next listing, the Part interface has several methods that mirror the methods in MultipartFile.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//Part interface: an alternative to Spring’s //MultipartFile</span><br><span class="line">public interface Part &#123;</span><br><span class="line">public InputStream getInputStream() throws IOException;</span><br><span class="line">public String getContentType();</span><br><span class="line">public String getName();</span><br><span class="line">public String getSubmittedFileName();</span><br><span class="line">public long getSize();</span><br><span class="line">public void write(String fileName) throws IOException;</span><br><span class="line">public void delete() throws IOException;</span><br><span class="line">public String getHeader(String name);</span><br><span class="line">public Collection&lt;String&gt; getHeaders(String name);</span><br><span class="line">public Collection&lt;String&gt; getHeaderNames();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It’s worth noting that if you write your controller handler methods to accept file uploads via a <strong>Part</strong> parameter, then you don’t need to configure the StandardServletMultipartResolver bean. StandardServletMultipartResolver is required only<br>when you’re working with MultipartFile.用Part不需要额外的配置，用MultipartFile还需要配置StandardServletMultipartResolver。那就尽量用Part呗！</p>
<h3>7.3Handling exceptions</h3>

<p>No matter what happens, good or bad, the outcome of a servlet request is a servlet response. If an exception occurs during request processing, the <strong>outcome is still a servlet response</strong>. Somehow, the exception must be translated into a response.</p>
<p>Spring offers a handful of ways to translate exceptions to responses:</p>
<p>1.Certain Spring exceptions are automatically mapped to specific HTTP status codes.<br>2.An exception can be annotated with <strong>@ResponseStatus</strong> to map it to an HTTP status code.<br>3.A method can be annotated with <strong>@ExceptionHandler</strong> to handle the exception.</p>
<h4>7.3.1Mapping exceptions to HTTP status codes</h4>

<p>如果为null，就会SpittleNotFoundException：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=&quot;/&#123;spittleId&#125;&quot;, method=RequestMethod.GET)</span><br><span class="line">public String spittle(</span><br><span class="line">@PathVariable(&quot;spittleId&quot;) long spittleId,</span><br><span class="line">Model model) &#123;</span><br><span class="line">Spittle spittle = spittleRepository.findOne(spittleId);</span><br><span class="line">if (spittle == null) &#123;</span><br><span class="line">throw new SpittleNotFoundException();</span><br><span class="line">&#125;</span><br><span class="line">model.addAttribute(spittle);</span><br><span class="line">return &quot;spittle&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在SpittleNotFoundException中绑定code：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package spittr.web;</span><br><span class="line">import org.springframework.http.HttpStatus;</span><br><span class="line">import org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line">//Map exception to HTTP Status 404</span><br><span class="line">@ResponseStatus(value=HttpStatus.NOT_FOUND,</span><br><span class="line">reason=&quot;Spittle Not Found&quot;)</span><br><span class="line">public class SpittleNotFoundException extends RuntimeException &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If a SpittleNotFoundException were to be thrown from a controller method, the response would have a status code of 404 and a reason of Spittle Not Found.</p>
<h4>7.3.2Writing exception-handling methods</h4>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//Handling an exception directly in a </span><br><span class="line">//request-handling method</span><br><span class="line">@RequestMapping(method=RequestMethod.POST)</span><br><span class="line">public String saveSpittle(SpittleForm form, Model model) &#123;</span><br><span class="line">try &#123;</span><br><span class="line">spittleRepository.save(</span><br><span class="line">new Spittle(null, form.getMessage(), new Date(),</span><br><span class="line">form.getLongitude(), form.getLatitude()));</span><br><span class="line">return &quot;redirect:/spittles&quot;;</span><br><span class="line">&#125; catch (DuplicateSpittleException e) &#123;//Catch //the exception</span><br><span class="line">return &quot;error/duplicate&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It works fine, but the method is a bit complex. Two paths can be taken, each with a different outcome. It’d be simpler if saveSpittle() could focus on the happy path and let some other method deal with the exception.最好将exception处理方法拿出来，形成两个方法。<br>First, let’s rip the exception-handling code out of saveSpittle():</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(method=RequestMethod.POST)</span><br><span class="line">public String saveSpittle(SpittleForm form, Model model) &#123;</span><br><span class="line">spittleRepository.save(</span><br><span class="line">new Spittle(null, form.getMessage(), new Date(),</span><br><span class="line">form.getLongitude(), form.getLatitude()));</span><br><span class="line">return &quot;redirect:/spittles&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now let’s add a new method to SpittleController that will handle the case where DuplicateSpittleException is thrown:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@ExceptionHandler(DuplicateSpittleException.class)</span><br><span class="line">public String handleDuplicateSpittle() &#123;</span><br><span class="line">return &quot;error/duplicate&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，我们就将主要的逻辑代码与异常处理代码分开了。并且，@ExceptionHandler方法可以接收同一个controller下的任何handler method。如果每个方法都有可能出现这种exception，这样统一写无疑是最简单的。</p>
<p>If @ExceptionHandler methods can handle exceptions thrown from any handler method in the same controller class, you might be wondering <strong>if there’s a way they can handle exceptions thrown from handler methods in any controller</strong>. As of Spring 3.2<br>they certainly can, but only if they’re defined in a <strong>controller advice class</strong>.</p>
<h3>7.4Advising controllers</h3>

<p>Certain aspects of controller classes might be handier if they could be applied broadly across all controllers in a given application.Or, to avoid the duplication, you might create a base controller class that all of your controllers could extend to inherit the common @ExceptionHandler method.</p>
<p>Spring 3.2 brings another option to the table: <strong>controller advice</strong>. A controller advice is any class that’s annotated with <strong>@ControllerAdvice</strong> and has one or more of the following kinds of methods:</p>
<p>1.@ExceptionHandler-annotated<br>2.@InitBinder-annotated<br>3.@ModelAttribute-annotated</p>
<p>Those methods in an @ControllerAdvice-annotated class are applied <strong>globally</strong> across all @RequestMapping-annotated methods on all controllers in an application.</p>
<p>One of the most practical uses for @ControllerAdvice is to <strong>gather all @ExceptionHandler methods in a single class</strong> so that exceptions from all controllers are handled consistently in one place.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//Using @ControllerAdvice to handle exception //for all controllers</span><br><span class="line">package spitter.web;</span><br><span class="line">import org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line">import org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line">@ControllerAdvice  //Declare controller advice</span><br><span class="line">public class AppWideExceptionHandler &#123;</span><br><span class="line">@ExceptionHandler(DuplicateSpittleException.class)</span><br><span class="line">//Define exceptionhandler method</span><br><span class="line">public String duplicateSpittleHandler() &#123;</span><br><span class="line">return &quot;error/duplicate&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>7.5Carrying data across redirect requests</h3>

<p>在前面提交表单的POST请求时，我们用了重定向。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return &quot;redirect:/spitter/&quot; + spitter.getUsername();</span><br></pre></td></tr></table></figure>
<p>但存在下面的问题，我们不能把在这个original request中得到的model中的数据传入到重定向的request中，如下：<br><img src="http://img.blog.csdn.net/20161011101035829" alt=""></p>
<p>Clearly, the model isn’t going to help you carry data across a redirect. But there are a couple of options to get the data from the redirecting method to the redirecthandling method:</p>
<p>1.Passing data as path variables and/or query parameters using URL templates<br>2.Sending data in flash attributes</p>
<h4>7.5.1Redirecting with URL templates</h4>

<p>It’s far<br>from bulletproof. String concatenation is dangerous business when constructing<br>things like URLs and SQL queries.</p>
<p>For example, the last line of processRegistration() could be written like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return &quot;redirect:/spitter/&#123;username&#125;&quot;;</span><br></pre></td></tr></table></figure>
<p>All you need to do is set the value in the model.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=&quot;/register&quot;, method=POST)</span><br><span class="line">public String processRegistration(</span><br><span class="line">Spitter spitter, Model model) &#123;</span><br><span class="line">spitterRepository.save(spitter);</span><br><span class="line">model.addAttribute(&quot;username&quot;, spitter.getUsername());</span><br><span class="line">return &quot;redirect:/spitter/&#123;username&#125;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>What’s more, any other primitive values in the model are also added to the redirect URL as query parameters.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=&quot;/register&quot;, method=POST)</span><br><span class="line">public String processRegistration(</span><br><span class="line">Spitter spitter, Model model) &#123;</span><br><span class="line">spitterRepository.save(spitter);</span><br><span class="line">model.addAttribute(&quot;username&quot;, spitter.getUsername());</span><br><span class="line">model.addAttribute(&quot;spitterId&quot;, spitter.getId());</span><br><span class="line">return &quot;redirect:/spitter/&#123;username&#125;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Not much has changed with regard to the redirect String being returned. But because the spitterId attribute from the model doesn’t map to any URL placeholders in the redirect, it’s tacked on to the redirect automatically as a query parameter.</p>
<p>If the username attribute is habuma and the spitterId attribute is 42, then the resulting redirect path will be /spitter/habuma?spitterId=42.</p>
<h4>7.5.2Working with flash attributes</h4>

<p>Let’s say that instead of sending a username or ID in the redirect, you want to send the actual Spitter object. If you send just the ID, then the method that handles the redirect has to turn around and look up the Spitter from the database. But before the redirect, you already have the Spitter object in hand. Why not send it to the redirecthandling method to display?如果redirect传入ID，那么还得从database中读取Spitter，为什么不直接传递Spitter对象呢?既然我们已经有了Spitter数据在手里。</p>
<p>A Spitter <strong>object</strong> is a bit more complex than a String or an int. Therefore, it can’t easily be sent as a path variable or a query parameter. It can, however, be <strong>set as an attribute in the model</strong>.</p>
<p>But as we’ve already discussed, model attributes are ultimately copied into the request as request attributes and <strong>are lost when the redirect takes place</strong>. Therefore, you need to put the Spitter object somewhere that will survive the redirect.</p>
<p>One option is to put the Spitter into the session. A session is long-lasting, spanning multiple requests.Instead, Spring offers the capability of sending the data as <strong>flash attributes</strong>. Flash attributes, by definition, carry data <strong>until the next request</strong>; then they go away.</p>
<p>Spring offers a way to set flash attributes via <strong>RedirectAttributes</strong>, a sub-interface of Model added in Spring 3.1. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=&quot;/register&quot;, method=POST)</span><br><span class="line">public String processRegistration(</span><br><span class="line">Spitter spitter, RedirectAttributes model) &#123;</span><br><span class="line">spitterRepository.save(spitter);</span><br><span class="line">model.addAttribute(&quot;username&quot;, spitter.getUsername());</span><br><span class="line">model.addFlashAttribute(&quot;spitter&quot;, spitter);</span><br><span class="line">return &quot;redirect:/spitter/&#123;username&#125;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Before the redirect takes place, all flash attributes are copied into the session. After the redirect, the flash attributes stored in the session are moved out of the session and into the model. The method that handles the redirect request can then access the Spitter from the model, just like any other model object. Figure 7.2 illustrates how this works.<br><img src="http://img.blog.csdn.net/20161012173353401" alt=""></p>
<h3>7.6Summary</h3>


<h1>Chapter8.Working with Spring Web Flow</h1>

<p>Spring Web Flow is a web framework that enables the development of elements following a prescribed flow.<br>Spring Web Flow is an extension to Spring MVC that enables development of flowbased web applications. It does this by separating the definition of an application’s flow from the classes and views that implement the flow’s behavior.</p>
<h3>8.1Configuring Web Flow in Spring</h3>

<p><strong>Spring Web Flow is built on a foundation of Spring MVC</strong>. <strong>That means all requests to a flow first go through Spring MVC’s DispatcherServlet</strong>. From there, a handful of special beans in the Spring application context must be configured to handle the flow request and execute the flow.</p>
<p>At this time, there’s no support for configuring Spring Web Flow in Java, so you have no choice but to configure it in XML.<strong>只能在XML中config。</strong>Therefore, you’ll need to add the namespace declaration to the context definition XML file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">xmlns:flow=&quot;http://www.springframework.org/schema/webflow-config&quot;</span><br><span class="line">xsi:schemaLocation=</span><br><span class="line">&quot;http://www.springframework.org/schema/webflow-config</span><br><span class="line">http://www.springframework.org/schema/webflow-config/[CA]</span><br><span class="line">spring-webflow-config-2.3.xsd</span><br><span class="line">http://www.springframework.org/schema/beans</span><br><span class="line">http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br></pre></td></tr></table></figure>
<h4>8.1.1Wiring a flow executor</h4>

<p>As its name implies, the flow executor drives the execution of a flow.The <code>&lt;flow:flow-executor&gt;</code> element creates a flow executor in Spring:<code>&lt;flow:flow-executor id=&quot;flowExecutor&quot; /&gt;</code></p>
<p>Although the flow executor is <strong>responsible for creating and executing flows</strong>, <strong>it’s not responsible for loading flow definitions</strong>. That responsibility falls to a flow registry, which you’ll create next.</p>
<h4>8.1.2Configuring a flow registry</h4>

<p>You can configure a flow registry in the Spring configuration with the <code>&lt;flow:flow-registry&gt;</code> element like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;flow:flow-registry id=&quot;flowRegistry&quot; base-path=&quot;/WEB-INF/flows&quot;&gt;</span><br><span class="line">&lt;flow:flow-location-pattern value=&quot;*-flow.xml&quot; /&gt;</span><br><span class="line">&lt;/flow:flow-registry&gt;</span><br></pre></td></tr></table></figure>
<p>As declared here, the flow registry will look for flow definitions under the /WEB-INF/flows directory, as specified in the base-path attribute. Per the <code>&lt;flow: flow-location-pattern&gt;</code> element, any XML file whose name ends with -flow.xml will be considered a flow definition.<br><img src="http://img.blog.csdn.net/20161012214149453" alt=""></p>
<p>还可以显式定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;flow:flow-registry id=&quot;flowRegistry&quot;&gt;</span><br><span class="line">&lt;flow:flow-location path=&quot;/WEB-INF/flows/springpizza.xml&quot; /&gt;</span><br><span class="line">&lt;/flow:flow-registry&gt;</span><br></pre></td></tr></table></figure>
<p>Here, the <code>&lt;flow:flow-location&gt;</code> element is used instead of <code>&lt;flow:flow-locationpattern&gt;</code>. The path attribute directly points at the /WEB-INF/flows/springpizza.xml file as the flow definition. When configured this way, the flow’s ID is derived from the base name of the flow definition file, <strong>springpizza in this case</strong>.</p>
<h4>8.1.3 Handling flow requests</h4>

<p>As you saw in the previous chapter, <strong>DispatcherServlet</strong> typically dispatches requests to controllers. But for flows, you need a <strong>FlowHandlerMapping</strong> to help DispatcherServlet know that it should send flow requests to Spring Web Flow. The FlowHandlerMapping is configured in the Spring application context like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean class=</span><br><span class="line">&quot;org.springframework.webflow.mvc.servlet.FlowHandlerMapping&quot;&gt;</span><br><span class="line">&lt;property name=&quot;flowRegistry&quot; ref=&quot;flowRegistry&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>As you can see, <strong>the FlowHandlerMapping is wired with a reference to the flow registry so it knows when a request’s URL maps to a flow</strong>. For example, if you have a flow whose <strong>ID is pizza</strong>, then FlowHandlerMapping will know to <strong>map</strong> a request to that flow if the request’s <strong>URL pattern (relative to the application context path) is /pizza</strong>.</p>
<p><strong>Whereas the FlowHandlerMapping’s job is to direct flow requests to Spring Web Flow, it’s the job of a FlowHandlerAdapter to answer that call</strong>.FlowHandlerAdapter在这点上相当于Spring MVC中的controller。The FlowHandlerAdapter is wired as a Spring bean like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean class=</span><br><span class="line">&quot;org.springframework.webflow.mvc.servlet.FlowHandlerAdapter&quot;&gt;</span><br><span class="line">&lt;property name=&quot;flowExecutor&quot; ref=&quot;flowExecutor&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<p>You’ve configured all the beans and components that are needed for Spring Web Flow to work. <strong>What’s left is to define a flow</strong>. You’ll do that soon enough. But first, let’s get to know the elements that are put together to make up a flow.</p>
<h3>8.2 The components of a flow</h3>

<p>In Spring Web Flow, a flow is defined by three primary elements: <strong>states</strong>, <strong>transitions</strong>, and <strong>flow data</strong>. States are points in a flow where something happens. If you imagine a flow as being like a road trip, then states are the towns, truck stops, and scenic stops along the way. Instead of picking up a bag of Doritos and a Diet Coke, <strong>a state in a flow is where some logic is performed, some decision is made, or some page is presented to the user</strong>.比喻很形象</p>
<p>If flow states are like the points on a map where you might stop during a road trip, then transitions are the roads that connect those points. <strong>In a flow, you get from one state to another by way of a transition</strong>.</p>
<h4>8.2.1 States</h4>

<p><img src="http://img.blog.csdn.net/20161012220642871" alt=""><br><strong>VIEW STATES</strong><br>View states are used to display information to the user and to offer the user an opportunity to play an active role in the flow. The actual view implementation could be any of the views supported by Spring MVC but is often implemented in JSP.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//如果没有指定view名称，那么默认为与id同名</span><br><span class="line">&lt;view-state id=&quot;welcome&quot; view=&quot;greeting&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<p>If a flow presents a form to the user, you may want to specify the object to which the form will be bound. To do that, set the model attribute:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;view-state id=&quot;takePayment&quot; model=&quot;flowScope.paymentDetails&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p><strong>ACTION STATES</strong></p>
<p>Whereas view states involve the users of the application in the flow, <strong>action states are where the application itself goes to work</strong>. Action states <strong>typically invoke some method</strong> on a Spring-managed bean and then transition to another state depending on the outcome of the method call.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;action-state id=&quot;saveOrder&quot;&gt;</span><br><span class="line">&lt;evaluate expression=&quot;pizzaFlowActions.saveOrder(order)&quot; /&gt;</span><br><span class="line">&lt;transition to=&quot;thankYou&quot; /&gt;</span><br><span class="line">&lt;/action-state&gt;</span><br></pre></td></tr></table></figure>
<p><strong>DECISION STATES</strong></p>
<p>有时候state需要分支。<strong>Decision states enable a binary branch in a flow execution</strong>. A decision state evaluates a Boolean expression and takes one of two transitions, depending on whether the expression evaluates to true or false. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;decision-state id=&quot;checkDeliveryArea&quot;&gt;</span><br><span class="line">&lt;if test=&quot;pizzaFlowActions.checkDeliveryArea(customer.zipCode)&quot;</span><br><span class="line">then=&quot;addCustomer&quot;</span><br><span class="line">else=&quot;deliveryWarning&quot; /&gt;</span><br><span class="line">&lt;/decision-state&gt;</span><br></pre></td></tr></table></figure>
<p><strong>SUBFLOW STATES</strong></p>
<p>You probably wouldn’t write all of your application’s logic in a single method. Instead, you’ll break it up into multiple classes, methods, and other structures.在FLOW中也是一样，就像在一个方法中调用另一个方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;subflow-state id=&quot;order&quot; subflow=&quot;pizza/order&quot;&gt;</span><br><span class="line">&lt;input name=&quot;order&quot; value=&quot;order&quot;/&gt;</span><br><span class="line">&lt;transition on=&quot;orderCreated&quot; to=&quot;payment&quot; /&gt;</span><br><span class="line">&lt;/subflow-state&gt;</span><br></pre></td></tr></table></figure>
<p><strong>Here, the <code>&lt;input&gt;</code> element is used to pass the order object as input to the subflow.And if the subflow ends with an <code>&lt;end-state&gt;</code> whose ID is orderCreated, then the flow will transition to the state whose ID is payment.</strong></p>
<p><strong>END STATES</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;end-state id=&quot;customerReady&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>When the flow reaches an <code>&lt;end-state&gt;</code>, the flow ends. What happens next depends<br>on a few factors:</p>
<p>1.If the flow that’s ending is a subflow, the calling flow will proceed from the <code>&lt;subflow-state&gt;</code>. The <code>&lt;end-state&gt;</code>’s ID will be used as an event to trigger the transition away from the <code>&lt;subflow-state&gt;</code>.有sub的情况，感觉与函数调用相似。<br>2.If the <code>&lt;end-state&gt;</code> has its view attribute set, the specified view will be rendered. The view may be a flow-relative path to a view template, prefixed with <strong>externalRedirect</strong>: to redirect to some page external to the flow, or prefixed with <strong>flowRedirect</strong>: to redirect to another flow.有view的情况。<br>3.If the ending flow isn’t a subflow and no view is specified, <strong>the flow ends（只有结束咯）</strong>. The browser lands on the flow’s base URL, and, with no current flow active, a new instance of the flow begins.</p>
<h4>8.2.2Transitions</h4>

<p>As I’ve already mentioned, transitions connect the states within a flow. <strong>Every state in a flow, with the exception of end states, should have at least one transition so that the flow will know where to go once that state has completed</strong>. A state may have multiple transitions, each one representing a different path that could be taken on completion of the state.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;transition to=&quot;customerReady&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>You can specify the event to trigger the transition in the on attribute:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;transition on=&quot;phoneEntered&quot; to=&quot;lookupCustomer&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>In this example, the flow will transition to the state whose ID is <strong>lookupCustomer</strong> if a <strong>phoneEntered</strong> event is fired.<br>The flow can also transition to another state in response to some exception being thrown. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;transition</span><br><span class="line">on-exception=</span><br><span class="line">&quot;com.springinaction.pizza.service.CustomerNotFoundException&quot;</span><br><span class="line">to=&quot;registrationForm&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p><strong>GLOBAL TRANSITIONS</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;global-transitions&gt;</span><br><span class="line">&lt;transition on=&quot;cancel&quot; to=&quot;endState&quot; /&gt;</span><br><span class="line">&lt;/global-transitions&gt;</span><br></pre></td></tr></table></figure>
<h4>8.2.3Flow data</h4>

<p>Sometimes that data is only needed for a little while (maybe just long enough to display a page to the user). Other times, that data is carried through the entire flow and is ultimately used as the flow completes.所以应该需要定义生命周期？</p>
<p><strong>DECLARING VARIABLES</strong><br>The simplest way to create a variable in a flow is by using the <code>&lt;var&gt;</code> element:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;var name=&quot;customer&quot; class=&quot;com.springinaction.pizza.domain.Customer&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>Here, a new instance of a Customer object is created and placed into the variable whose name is customer. This variable is available to all states in a flow.<br>还有其他定义方法，比如<code>&lt;evaluate&gt;</code>，<code>&lt;set&gt;</code>。</p>
<p><strong>SCOPING FLOW DATA</strong></p>
<p>The <strong>lifespan</strong> and <strong>visibility</strong> of data carried in a flow will vary depending on the scope of the variable it’s kept in. Spring Web Flow defines five scopes, as described in table 8.2.<br><img src="http://img.blog.csdn.net/20161012225413098" alt=""></p>
<p>When you declare a variable using the <code>&lt;var&gt;</code> element, the variable <strong>is always flowscoped</strong> in the flow defining the variable. When you use <code>&lt;set&gt;</code> or <code>&lt;evaluate&gt;</code>, the scope is specified as a prefix for the name or result attribute. For example, here’s how you would assign a value to a flow-scoped variable named theAnswer:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;set name=&quot;flowScope.theAnswer&quot; value=&quot;42&quot;/&gt;</span><br></pre></td></tr></table></figure>
<h3>8.3Putting it all together: the pizza flow</h3>

<p>As it turns out, the process of ordering a pizza can be defined nicely in a flow.<br>You’ll start by building a high-level flow that defines the overall process of ordering a pizza. Then you’ll break that flow down into subflows that define the details at a lower level.</p>
<h4>8.3.1Defining the base flow</h4><br>先粗粒度的定义FLOW：<br><img src="http://img.blog.csdn.net/20161013102456498" alt=""><br><br>The following listing shows the high-level pizza order flow as defined using Spring Web Flow’s XML-based flow definition.<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//Pizza order flow, defined as a Spring Web Flow</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;flow xmlns=&quot;http://www.springframework.org/schema/webflow&quot;</span><br><span class="line">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">xsi:schemaLocation=&quot;http://www.springframework.org/schema/webflow</span><br><span class="line">http://www.springframework.org/schema/webflow/spring-webflow-2.3.xsd&quot;&gt;</span><br><span class="line">&lt;var name=&quot;order&quot;</span><br><span class="line">class=&quot;com.springinaction.pizza.domain.Order&quot;/&gt;</span><br><span class="line">//Call customer subflow</span><br><span class="line">&lt;subflow-state id=&quot;identifyCustomer&quot; subflow=&quot;pizza/customer&quot;&gt;</span><br><span class="line">&lt;output name=&quot;customer&quot; value=&quot;order.customer&quot;/&gt;</span><br><span class="line">&lt;transition on=&quot;customerReady&quot; to=&quot;buildOrder&quot; /&gt;</span><br><span class="line">&lt;/subflow-state&gt;</span><br><span class="line">//Call order subflow</span><br><span class="line">&lt;subflow-state id=&quot;buildOrder&quot; subflow=&quot;pizza/order&quot;&gt;</span><br><span class="line">&lt;input name=&quot;order&quot; value=&quot;order&quot;/&gt;</span><br><span class="line">&lt;transition on=&quot;orderCreated&quot; to=&quot;takePayment&quot; /&gt;</span><br><span class="line">&lt;/subflow-state&gt;</span><br><span class="line">//Call payment subflow</span><br><span class="line">&lt;subflow-state id=&quot;takePayment&quot; subflow=&quot;pizza/payment&quot;&gt;</span><br><span class="line">&lt;input name=&quot;order&quot; value=&quot;order&quot;/&gt;</span><br><span class="line">&lt;transition on=&quot;paymentTaken&quot; to=&quot;saveOrder&quot;/&gt;</span><br><span class="line">&lt;/subflow-state&gt;</span><br><span class="line">//Save order</span><br><span class="line">&lt;action-state id=&quot;saveOrder&quot;&gt;</span><br><span class="line">&lt;evaluate expression=&quot;pizzaFlowActions.saveOrder(order)&quot; /&gt;</span><br><span class="line">//Thank customer</span><br><span class="line">&lt;transition to=&quot;thankCustomer&quot; /&gt;</span><br><span class="line">&lt;/action-state&gt;</span><br><span class="line">&lt;view-state id=&quot;thankCustomer&quot;&gt;</span><br><span class="line">&lt;transition to=&quot;endState&quot; /&gt;</span><br><span class="line">&lt;/view-state&gt;</span><br><span class="line">&lt;end-state id=&quot;endState&quot; /&gt;</span><br><span class="line">//Global cancel transition</span><br><span class="line">&lt;global-transitions&gt;</span><br><span class="line">&lt;transition on=&quot;cancel&quot; to=&quot;endState&quot; /&gt;</span><br><span class="line">&lt;/global-transitions&gt;</span><br><span class="line">&lt;/flow&gt;</span><br></pre></td></tr></table></figure><br><br>The first thing you see in the flow definition is the declaration of the order variable. <strong>Each time the flow starts, a new instance of Order is created</strong>. The Order class has properties for carrying all the information about an order, including the customer information, the list of pizzas ordered, and the payment details.<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">//Order: carries all the details pertaining to a //pizza order</span><br><span class="line">package com.springinaction.pizza.domain;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">public class Order implements Serializable &#123;</span><br><span class="line">private static final long serialVersionUID = 1L;</span><br><span class="line">private Customer customer;</span><br><span class="line">private List&lt;Pizza&gt; pizzas;</span><br><span class="line">private Payment payment;</span><br><span class="line">public Order() &#123;</span><br><span class="line">pizzas = new ArrayList&lt;Pizza&gt;();</span><br><span class="line">customer = new Customer();</span><br><span class="line">&#125;</span><br><span class="line">public Customer getCustomer() &#123;</span><br><span class="line">return customer;</span><br><span class="line">&#125;</span><br><span class="line">public void setCustomer(Customer customer) &#123;</span><br><span class="line">this.customer = customer;</span><br><span class="line">&#125;</span><br><span class="line">public List&lt;Pizza&gt; getPizzas() &#123;</span><br><span class="line">return pizzas;</span><br><span class="line">&#125;</span><br><span class="line">public void setPizzas(List&lt;Pizza&gt; pizzas) &#123;</span><br><span class="line">this.pizzas = pizzas;</span><br><span class="line">&#125;</span><br><span class="line">public void addPizza(Pizza pizza) &#123;</span><br><span class="line">pizzas.add(pizza);</span><br><span class="line">&#125;</span><br><span class="line">public float getTotal() &#123;</span><br><span class="line">return 0.0f;</span><br><span class="line">&#125;</span><br><span class="line">public Payment getPayment() &#123;</span><br><span class="line">return payment;</span><br><span class="line">&#125;</span><br><span class="line">public void setPayment(Payment payment) &#123;</span><br><span class="line">this.payment = payment;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>At the end state, the flow ends. <strong>Because there are no further details on where to go after the flow ends, the flow will start over again at the identifyCustomer state, ready to take another pizza order</strong>.<br><br>That covers the general flow for ordering a pizza. But there’s more to the flow than what you see in listing 8.1. You still need to define the subflows for the identifyCustomer, buildOrder, and takePayment states. Let’s build those flows next, starting with the one that identifies the customer.分别定义三个sub-flow。<br><br><h4>8.3.2Collecting customer information</h4><br><img src="http://img.blog.csdn.net/20161013104623019" alt=""><br><br>The following listing shows the flow definition for identifying the customer.<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">//Identifying the hungry pizza customer with a //web flow</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;flow xmlns=&quot;http://www.springframework.org/schema/webflow&quot;</span><br><span class="line">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">xsi:schemaLocation=&quot;http://www.springframework.org/schema/webflow</span><br><span class="line">http://www.springframework.org/schema/webflow/spring-webflow-2.3.xsd&quot;&gt;</span><br><span class="line">&lt;var name=&quot;customer&quot;</span><br><span class="line">class=&quot;com.springinaction.pizza.domain.Customer&quot;/&gt;</span><br><span class="line">//Welcome customer</span><br><span class="line">&lt;view-state id=&quot;welcome&quot;&gt;</span><br><span class="line">&lt;transition on=&quot;phoneEntered&quot; to=&quot;lookupCustomer&quot;/&gt;</span><br><span class="line">&lt;/view-state&gt;</span><br><span class="line">//Look up customer</span><br><span class="line">&lt;actionstate id=&quot;lookupCustomer&quot;&gt;</span><br><span class="line">&lt;evaluate result=&quot;customer&quot; expression=</span><br><span class="line">&quot;pizzaFlowActions.lookupCustomer(requestParameters.phoneNumber)&quot; /&gt;</span><br><span class="line">&lt;transition to=&quot;registrationForm&quot; on-exception=</span><br><span class="line">&quot;com.springinaction.pizza.service.CustomerNotFoundException&quot; /&gt;</span><br><span class="line">&lt;transition to=&quot;customerReady&quot; /&gt;</span><br><span class="line">&lt;/action-state&gt;</span><br><span class="line">//Register new customer</span><br><span class="line">&lt;view-state id=&quot;registrationForm&quot; model=&quot;customer&quot;&gt;</span><br><span class="line">&lt;on-entry&gt;</span><br><span class="line">&lt;evaluate expression=</span><br><span class="line">&quot;customer.phoneNumber = requestParameters.phoneNumber&quot; /&gt;</span><br><span class="line">&lt;/on-entry&gt;</span><br><span class="line">&lt;transition on=&quot;submit&quot; to=&quot;checkDeliveryArea&quot; /&gt;</span><br><span class="line">&lt;/view-state&gt;</span><br><span class="line">//Check delivery area</span><br><span class="line">&lt;decision-state id=&quot;checkDeliveryArea&quot;&gt;</span><br><span class="line">&lt;if test=&quot;pizzaFlowActions.checkDeliveryArea(customer.zipCode)&quot;</span><br><span class="line">then=&quot;addCustomer&quot;</span><br><span class="line">else=&quot;deliveryWarning&quot;/&gt;</span><br><span class="line">&lt;/decision-state&gt;</span><br><span class="line">//Show delivery warning</span><br><span class="line">&lt;view-state id=&quot;deliveryWarning&quot;&gt;</span><br><span class="line">&lt;transition on=&quot;accept&quot; to=&quot;addCustomer&quot; /&gt;</span><br><span class="line">&lt;/view-state&gt;</span><br><span class="line">//Add customer</span><br><span class="line">&lt;action-state id=&quot;addCustomer&quot;&gt;</span><br><span class="line">&lt;evaluate expression=&quot;pizzaFlowActions.addCustomer(customer)&quot; /&gt;</span><br><span class="line">&lt;transition to=&quot;customerReady&quot; /&gt;</span><br><span class="line">&lt;/action-state&gt;</span><br><span class="line">&lt;end-state id=&quot;cancel&quot; /&gt;</span><br><span class="line">&lt;end-state id=&quot;customerReady&quot;&gt;</span><br><span class="line">&lt;output name=&quot;customer&quot; /&gt;</span><br><span class="line">&lt;/end-state&gt;</span><br><span class="line">&lt;global-transitions&gt;</span><br><span class="line">&lt;transition on=&quot;cancel&quot; to=&quot;cancel&quot; /&gt;</span><br><span class="line">&lt;/global-transitions&gt;</span><br><span class="line">&lt;/flow&gt;</span><br></pre></td></tr></table></figure><br><br>sub-flow与flow的关系很像android中的viewgroup与view的关系。<br><br>Where the welcome state gets interesting is in the view. The welcome view is defined in /WEB INF/flows/pizza/customer/welcome.jspx, as shown next.<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//Welcoming the customer and asking for their //phone number</span><br><span class="line">&lt;html xmlns:jsp=&quot;http://java.sun.com/JSP/Page&quot;</span><br><span class="line">xmlns:form=&quot;http://www.springframework.org/tags/form&quot;&gt;</span><br><span class="line">&lt;jsp:output omit-xml-declaration=&quot;yes&quot;/&gt;</span><br><span class="line">&lt;jsp:directive.page contentType=&quot;text/html;charset=UTF-8&quot; /&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;Spizza&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Welcome to Spizza!!!&lt;/h2&gt;</span><br><span class="line">&lt;form:form&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; name=&quot;_flowExecutionKey&quot;</span><br><span class="line">value=&quot;$&#123;flowExecutionKey&#125;&quot;/&gt;//Flow execution //key</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;phoneNumber&quot;/&gt;&lt;br/&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; name=&quot;_eventId_phoneEntered&quot;</span><br><span class="line">value=&quot;Lookup Customer&quot; /&gt;//Fire phoneEntered //event</span><br><span class="line">&lt;/form:form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><br><br>Pay special attention to the submit button’s name. The <code>_eventId_</code> portion of the button’s name is a clue to Spring Web Flow that what follows is an event that should be fired. When the form is submitted by clicking that button, a <strong>phoneEntered</strong> event is fired, triggering a <strong>transition</strong> to <strong>lookupCustomer</strong>.<br><br><strong>LOOKING UP THE CUSTOMER</strong><br><br>After the welcome form has been submitted, the customer’s phone number is among the request parameters and is ready to be used to look up a customer. The lookupCustomer state’s <code>&lt;evaluate&gt;</code> element is where that happens. <strong>It pulls the phone number off the request parameters and passes it to the lookupCustomer() method on the pizzaFlowActions bean</strong>.上面代码节选：<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//选出phoneNumber</span><br><span class="line">&lt;evaluate result=&quot;customer&quot; expression=</span><br><span class="line">&quot;pizzaFlowActions.lookupCustomer(requestParameters.phoneNumber)&quot; /&gt;</span><br></pre></td></tr></table></figure><br><br>The implementation of <strong>lookupCustomer()</strong> isn’t important right now. It’s sufficient to know that <strong>it will either return a Customer object or throw a CustomerNotFoundException</strong>.<br><br><strong>REGISTERING A NEW CUSTOMER</strong><br><br><strong>CHECKING THE DELIVERY AREA</strong><br><br><strong>STORING THE CUSTOMER DATA</strong><br><br><strong>ENDING THE FLOW</strong><br><br>Note that the customerReady end state includes an <code>&lt;output&gt;</code> element. This element is a flow’s <strong>equivalent of Java’s return statement</strong>. It passes back some data from a subflow to the calling flow. In this case, <code>&lt;output&gt;</code> returns the customer flow variable so that the identifyCustomer subflow state in the pizza flow can assign it to the order.<br>On the other hand, if a cancel event is triggered at any time during the customer flow, it exits the flow through the end state whose ID is cancel. That triggers a cancel event in the pizza flow and results in a transition (<strong>via the global transition</strong>) to the pizza flow’s end state.<br><br><h4>8.3.3Building an order</h4><br><img src="http://img.blog.csdn.net/20161013115928101" alt=""><br>代码配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">//Order subflow view shows states to display the //order and create a pizza</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;flow xmlns=&quot;http://www.springframework.org/schema/webflow&quot;</span><br><span class="line">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">xsi:schemaLocation=&quot;http://www.springframework.org/schema/webflow</span><br><span class="line">http://www.springframework.org/schema/webflow/spring-webflow-2.3.xsd&quot;&gt;</span><br><span class="line">//Accept order as input</span><br><span class="line">&lt;input name=&quot;order&quot; required=&quot;true&quot; /&gt;</span><br><span class="line">//Order display state</span><br><span class="line">&lt;view-state id=&quot;showOrder&quot;&gt;</span><br><span class="line">&lt;transition on=&quot;createPizza&quot; to=&quot;createPizza&quot; /&gt;</span><br><span class="line">&lt;transition on=&quot;checkout&quot; to=&quot;orderCreated&quot; /&gt;</span><br><span class="line">&lt;transition on=&quot;cancel&quot; to=&quot;cancel&quot; /&gt;</span><br><span class="line">&lt;/view-state&gt;</span><br><span class="line">//Pizza creation state</span><br><span class="line">&lt;viewstate id=&quot;createPizza&quot; model=&quot;flowScope.pizza&quot;&gt;</span><br><span class="line">&lt;on-entry&gt;</span><br><span class="line">&lt;set name=&quot;flowScope.pizza&quot;</span><br><span class="line">value=&quot;new com.springinaction.pizza.domain.Pizza()&quot; /&gt;</span><br><span class="line">&lt;evaluate result=&quot;viewScope.toppingsList&quot; expression=</span><br><span class="line">&quot;T(com.springinaction.pizza.domain.Topping).asList()&quot; /&gt;</span><br><span class="line">&lt;/on-entry&gt;</span><br><span class="line">&lt;transition on=&quot;addPizza&quot; to=&quot;showOrder&quot;&gt;</span><br><span class="line">&lt;evaluate expression=&quot;order.addPizza(flowScope.pizza)&quot; /&gt;</span><br><span class="line">&lt;/transition&gt;</span><br><span class="line">&lt;transition on=&quot;cancel&quot; to=&quot;showOrder&quot; /&gt;</span><br><span class="line">&lt;/view-state&gt;</span><br><span class="line">//Cancel end state</span><br><span class="line">&lt;end-state id=&quot;cancel&quot; /</span><br><span class="line">//Create order end state</span><br><span class="line">&lt;end-state id=&quot;orderCreated&quot; /&gt;</span><br><span class="line">&lt;/flow&gt;</span><br></pre></td></tr></table></figure><br><br><h4>8.3.4 Taking payment</h4><br><img src="http://img.blog.csdn.net/20161013140408442" alt=""><br><br>The payment subflow is defined in XML as shown next.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//Payment subflow, with one view state and one //action state</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;flow xmlns=&quot;http://www.springframework.org/schema/webflow&quot;</span><br><span class="line">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">xsi:schemaLocation=&quot;http://www.springframework.org/schema/webflow</span><br><span class="line">http://www.springframework.org/schema/webflow/spring-webflow-2.3.xsd&quot;&gt;</span><br><span class="line">&lt;input name=&quot;order&quot; required=&quot;true&quot;/&gt;</span><br><span class="line">&lt;view-state id=&quot;takePayment&quot; model=&quot;flowScope.paymentDetails&quot;&gt;</span><br><span class="line">&lt;on-entry&gt;</span><br><span class="line">&lt;set name=&quot;flowScope.paymentDetails&quot;</span><br><span class="line">value=&quot;new com.springinaction.pizza.domain.PaymentDetails()&quot; /&gt;</span><br><span class="line">&lt;evaluate result=&quot;viewScope.paymentTypeList&quot; expression=</span><br><span class="line">&quot;T(com.springinaction.pizza.domain.PaymentType).asList()&quot; /&gt;</span><br><span class="line">&lt;/on-entry&gt;</span><br><span class="line">&lt;transition on=&quot;paymentSubmitted&quot; to=&quot;verifyPayment&quot; /&gt;</span><br><span class="line">&lt;transition on=&quot;cancel&quot; to=&quot;cancel&quot; /&gt;</span><br><span class="line">&lt;/view-state&gt;</span><br><span class="line">&lt;action-state id=&quot;verifyPayment&quot;&gt;</span><br><span class="line">&lt;evaluate result=&quot;order.payment&quot; expression=</span><br><span class="line">&quot;pizzaFlowActions.verifyPayment(flowScope.paymentDetails)&quot; /&gt;</span><br><span class="line">&lt;transition to=&quot;paymentTaken&quot; /&gt;</span><br><span class="line">&lt;/action-state&gt;</span><br><span class="line">&lt;end-state id=&quot;cancel&quot; /&gt;</span><br><span class="line">&lt;end-state id=&quot;paymentTaken&quot; /&gt;</span><br><span class="line">&lt;/flow&gt;</span><br></pre></td></tr></table></figure><br><br> You’ve seen a lot of what Spring Web Flow is capable of. Before we finish with the Web Flow topic,<br>let’s take a quick look at what’s involved in securing access to a flow or any of its states.<br><br><h3>8.4 Securing web flows</h3><br><br>States, transitions, and entire flows can be secured in Spring Web Flow by using the <code>&lt;secured&gt;</code> element as a child of those elements. For example, to secure access to a view state, you might use <code>&lt;secured&gt;</code> like this:<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;view-state id=&quot;restricted&quot;&gt;</span><br><span class="line">&lt;secured attributes=&quot;ROLE_ADMIN&quot; match=&quot;all&quot;/&gt;</span><br><span class="line">&lt;/view-state&gt;</span><br></pre></td></tr></table></figure><br><br>As configured here, access to the view state will be restricted to only users who are granted <strong>ROLE_ADMIN</strong> access (per the attributes attribute). The attributes attribute takes a comma-separated list of authorities that the user must have to gain access to the state, transition, or flow. The match attribute can be set to either <strong>any</strong> or <strong>all</strong>. If it’s set to any, then the user must be granted at least one of the authorities listed in attributes. If it’s set to all, then the user must have been granted all the authorities.<br><br><h3>8.5Summary</h3><br><br>Not all web applications are freely navigable. Sometimes a user must be guided along, asked appropriate questions, and led to specific pages based on their responses. In these situations, an application feels less like a menu of options and more like a conversation between the application and the user.<br><br>A flow is made up of several states and transitions that define how the conversation traverses from state to state. The states themselves come in several varieties: <strong>action states</strong> that perform business logic, <strong>view states</strong> that involve the user in the flow, <strong>decision states</strong> that dynamically direct the flow, and <strong>end states</strong> that signify the end of a flow. In addition, there are <strong>subflow states</strong>, which are themselves defined by a flow.<br><br><br><h1>Chapter9.Securing web applications</h1><br><br>If you’re thinking that it’s starting to sound as if security is accomplished using aspect-oriented techniques, you’re right.But you won’t have to develop those aspects yourself—we’re going to look at <strong>Spring Security</strong>, a security framework implemented with Spring AOP and servlet filters.<br><br><h3>9.1Getting started with Spring Security</h3><br><br>Now at version 3.2, Spring Security tackles security from two angles. To secure web requests and restrict access <strong>at the URL level</strong>, Spring Security uses <strong>servlet filters</strong>. Spring Security can also secure <strong>method invocations</strong> using Spring AOP, <strong>proxying objects and applying advice to ensure that the user has the proper authority to invoke secured<br>methods</strong>.<br><br>We’ll focus on web-layer security with Spring Security in this chapter.<br><br><h4>9.1.1Understanding Spring Security modules</h4>

<p><img src="http://img.blog.csdn.net/20161013143622471" alt=""><br>在这一章secure web中，我们只用Core，Configuration，Web，Tag Library。</p>
<h4>9.1.2Filtering web requests</h4>

<p><strong>DelegatingFilterProxy</strong> is a special servlet filter that, by itself, doesn’t do much.<br>Instead, it delegates to an implementation of javax.servlet.Filter that’s registered as a <code>&lt;bean&gt;</code> in the Spring application context, as illustrated in figure 9.1.<br><img src="http://img.blog.csdn.net/20161013150623716" alt=""></p>
<p>If you’d rather configure <strong>DelegatingFilterProxy</strong> in Java with a <strong>WebApplicationInitializer</strong>, then all you need to do is create a new class that extends <strong>AbstractSecurityWebApplicationInitializer</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package spitter.config;</span><br><span class="line">import org.springframework.security.web.context.</span><br><span class="line">AbstractSecurityWebApplicationInitializer;</span><br><span class="line">public class SecurityWebInitializer</span><br><span class="line">extends AbstractSecurityWebApplicationInitializer &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>AbstractSecurityWebApplicationInitializer</strong> implements <strong>WebApplicationInitializer</strong>, so it will be discovered by Spring and be used to register <strong>DelegatingFilterProxy</strong> with the web container. Although you can override its appendFilters() or insertFilters() methods to register filters of your own choosing, <strong>you need not override anything to register DelegatingFilterProxy</strong>.</p>
<p>It will intercept requests coming into the application and delegate them to a bean whose ID is <strong>springSecurityFilterChain</strong>.</p>
<h4>9.1.3Writing a simple security configuration</h4>

<p>The following listing shows the simplest possible Java configuration for Spring Security.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//The simplest configuration class to enable web //security for Spring MVC</span><br><span class="line">package spitter.config;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.web.</span><br><span class="line">configuration.EnableWebSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.</span><br><span class="line">configuration.WebSecurityConfigurerAdapter;</span><br><span class="line">@Configuration</span><br><span class="line">//Enable web security</span><br><span class="line">@EnableWebSecurity</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring Security must be configured in a bean that <strong>1.implements WebSecurityConfigurer</strong> or (for convenience) <strong>2.extends WebSecurityConfigurerAdapter</strong>. <strong>Any bean in the Spring application context that implements WebSecurityConfigurer can contribute to Spring Security configuration</strong>, but it’s often most<br>convenient for the configuration class to extend WebSecurityConfigurerAdapter, as shown in listing 9.1.</p>
<p>@EnableWebSecurity适用于任何web安全，如果你要开发Spring MVC程序，那么就用@EnableWebMvcSecurity。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//The simplest configuration class to enable web //security for Spring MVC</span><br><span class="line">package spitter.config;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.web.</span><br><span class="line">configuration.WebSecurityConfigurerAdapter;</span><br><span class="line">import org.springframework.security.config.annotation.web.servlet.</span><br><span class="line">configuration.EnableWebMvcSecurity;</span><br><span class="line">@Configuration</span><br><span class="line">//Enable Spring MVC security</span><br><span class="line">@EnableWebMvcSecurity</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20161013153508572" alt=""></p>
<p>You’re going to need to add a bit more configuration to bend Spring Security to fit your application’s needs. Specifically, you’ll need to…</p>
<p>1.Configure a user store<br>2.Specify which requests should and should not require authentication, as well as what authorities they require<br>3.Provide a custom login screen to replace the plain   default login screen</p>
<h3>9.2Selecting user details services</h3>

<p>几周前，你跟餐馆定了座位，但是list中并没有你的名字。<br>That’s the scenario you have with your application at this point. There’s no way to get into the application because even if the user thinks they should be allowed in, <strong>there’s no record of them having access to the application</strong>. <strong>For lack of a user store, the application is so exclusive that it’s completely unusable</strong>.所以必须要有user store。</p>
<p>Spring Security’s Java configuration makes it easy to configure one or more data store options. We’ll start with the simplest user store: one that maintains its user store in memory.</p>
<h4>9.2.1Working with an in-memory user store</h4>

<p>For example, in the following listing, SecurityConfig overrides <strong>configure()</strong> to configure an in-memory user store with two users.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//Configuring Spring Security to use an </span><br><span class="line">//in-memory user store</span><br><span class="line">package spitter.config;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.</span><br><span class="line">authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line">import org.springframework.security.config.annotation.web.</span><br><span class="line">configuration.WebSecurityConfigurerAdapter;</span><br><span class="line">import org.springframework.security.config.annotation.web.servlet.</span><br><span class="line">configuration.EnableWebMvcSecurity;</span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebMvcSecurity</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">@Override</span><br><span class="line">protected void configure(AuthenticationManagerBuilder auth)</span><br><span class="line">throws Exception &#123;</span><br><span class="line">//Enable an in-memory user store.</span><br><span class="line">auth</span><br><span class="line">.inMemoryAuthentication()</span><br><span class="line">.withUser(&quot;user&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;).and()</span><br><span class="line">.withUser(&quot;admin&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;, &quot;ADMIN&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see, the and() method is used to chain together multiple user configurations.<br><img src="http://img.blog.csdn.net/20161013162335148" alt=""></p>
<p>For production-ready purposes, it’s usually better to maintain user data in a database of some sort.</p>
<h4>9.2.2Authenticating against database tables</h4>

<p>用JDBC存入数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">DataSource dataSource;</span><br><span class="line">@Override</span><br><span class="line">protected void configure(AuthenticationManagerBuilder auth)</span><br><span class="line">throws Exception &#123;</span><br><span class="line">auth</span><br><span class="line">.jdbcAuthentication()</span><br><span class="line">.dataSource(dataSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>OVERRIDING THE DEFAULT USER QUERIES</strong></p>
<p><strong>WORKING WITH ENCODED PASSWORDS</strong><br>No matter which password encoder you use, it’s important to understand that the <strong>password in the database is never decoded</strong>. Instead, the password that the user enters at login is encoded using the same algorithm and is then compared with the encoded password in the database. That comparison is performed in the PasswordEncoder’s <strong>matches()</strong> method.</p>
<h4>9.2.3Applying LDAP-backed authentication</h4>

<h4> 9.2.4Configuring a custom user service</h4>

<p>Suppose that you need to authenticate against users in a <strong>non-relational database</strong> such as <strong>Mongo</strong> or <strong>Neo4j</strong>. In that case, you’ll need to implement a custom implementation of the <strong>UserDetailsService</strong> interface.</p>
<h3>9.3Intercepting requests</h3>

<p>In any given application, not all requests should be secured equally. Some may require authentication; some may not. Some requests may only be available to users with certain authorities and unavailable to those without those authorities.</p>
<p>The key to fine-tuning security for each request is to <strong>override the configure (HttpSecurity) method</strong>. The following code snippet shows how you might override configure(HttpSecurity) to selectively apply security to different URL paths.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">http</span><br><span class="line">.authorizeRequests()</span><br><span class="line">.antMatchers(&quot;/spitters/me&quot;).authenticated()</span><br><span class="line">.antMatchers(HttpMethod.POST, &quot;/spittles&quot;).authenticated()</span><br><span class="line">.anyRequest().permitAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面的代码，可以看出组成元素有两个：1.request path，2.对path的方法。<br>要定义request path可以有很多方法：比如正则表达式.regexMatchers()等。<br>要定义对path的方法，有如下几种：<br><img src="http://img.blog.csdn.net/20161013170225200" alt=""><br>The <strong>authenticated() method</strong> demands that the user have logged into the application to perform the request. If the user isn’t authenticated, Spring Security’s filters will capture the request and redirect the user to the application’s login page. Meanwhile, the <strong>permitAll() method</strong> allows the requests without any security demands.</p>
<p>You can chain as many calls to <strong>antMatchers()</strong>, <strong>regexMatchers()</strong>, and <strong>anyRequest()</strong> as you need to fully establish the security rules around your web application. </p>
<p>You should know, however, that they’ll <strong>be applied in the order given</strong>. 他们是按照顺序来执行的。</p>
<p>For that reason, it’s important to <strong>configure the most specific request path patterns first and the least specific ones (such as anyRequest()) last</strong>. If not, then the least specific paths will trump the more specific ones.</p>
<h4>9.3.1Securing with Spring Expressions</h4>

<p>Most of the methods in table 9.4 are <strong>one-dimensional</strong>. That is, you can use hasRole() to require a certain role, but you can’t also use hasIpAddress() to require a specific IP address on the same path.也就是说table 9.4中的方法不能链式调用。</p>
<p><img src="http://img.blog.csdn.net/20161013171229418" alt=""><br><img src="http://img.blog.csdn.net/20161013171321084" alt=""></p>
<p>For example, if you wanted to lock down the /spitter/me URLs to not only require ROLE_SPITTER, but to also only be allowed from a given IP address, you might call the access() method like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(&quot;/spitter/me&quot;)</span><br><span class="line">.access(&quot;hasRole(&apos;ROLE_SPITTER&apos;) and hasIpAddress(&apos;192.168.1.2&apos;)&quot;)</span><br></pre></td></tr></table></figure>
<h4>9.3.2Enforcing channel security</h4>

<p>That’s why sensitive information should be sent encrypted over HTTPS.<br>If you have several links in your app that require HTTPS, chances are good that you’ll forget to add an s or two.<br>On the other hand, you might overcorrect and use HTTPS in places where it’s unnecessary.</p>
<p>To ensure that the registration form is sent over HTTPS, you can <strong>add requiresChannel() to the configuration</strong>, as in the following listing.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//The requiresChannel() method enforces HTTPS //for select URLs</span><br><span class="line">@Override</span><br><span class="line">protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">http</span><br><span class="line">.authorizeRequests()</span><br><span class="line">.antMatchers(&quot;/spitter/me&quot;).hasRole(&quot;SPITTER&quot;)</span><br><span class="line">.antMatchers(HttpMethod.POST, &quot;/spittles&quot;).hasRole(&quot;SPITTER&quot;)</span><br><span class="line">.anyRequest().permitAll();</span><br><span class="line">.and()</span><br><span class="line">.requiresChannel()</span><br><span class="line">.antMatchers(&quot;/spitter/form&quot;).requiresSecure();</span><br><span class="line">//Require HTTPS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Conversely, some pages don’t need to be sent over HTTPS. The home page, for example, doesn’t carry any sensitive information and should be sent over HTTP. You can declare that the home page always be sent over HTTP by using <strong>requiresInsecure()</strong> instead of <strong>requiresSecure</strong>.</p>
<h4>9.3.3Preventing cross-site request forgery</h4>

<p>Basically, a CSRF attack happens when one site tricks a user into submitting a request to another server,possibly having a negative outcome.</p>
<p><strong>Spring Security implements CSRF protection with a synchronizer token</strong>. Statechanging requests (for example, any request that is not GET, HEAD, OPTIONS, or TRACE) will be intercepted and checked for a CSRF token. If the request doesn’t carry a CSRF token, or if the token doesn’t match the token on the server, the request will fail with a CsrfException.</p>
<p>Fortunately, Spring Security makes this easy for you by putting the token into the request under the request attributes. If you’re using <strong>Thymeleaf</strong> for your page template, you’ll get the hidden <strong>_csrf field</strong> automatically, as long as the <code>&lt;form&gt;</code> tag’s action attribute is prefixed to come from the Thymeleaf namespace:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;form method=&quot;POST&quot; th:action=&quot;@&#123;/spittles&#125;&quot;&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>Another way of dealing with CSRF is to not deal with it at all. You can <strong>disable Spring Security’s CSRF protection</strong> by calling <strong>csrf().disable()</strong> in the configuration, as shown in the next listing.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">http</span><br><span class="line">...</span><br><span class="line">.csrf()</span><br><span class="line">.disable();//Disable CSRF protection</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>9.4Authenticating users</h3>

<h4>9.4.1Adding a custom login page</h4><br><h4>9.4.2 Enabling HTTP Basic authentication</h4><br><h4>9.4.3Enabling remember-me functionality</h4><br><h4>9.4.4Logging out</h4>

<h3>9.5Securing the view</h3>

<h4>9.5.1 Using Spring Security’s JSP tag library</h4><br><h4>9.5.2Working with Thymeleaf’s Spring Security dialect</h4>

<h3>9.6Summary</h3>

  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Spring/">Spring</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2016/10/09/Spring in action--Part2-Spring On The Web/" data-title="Spring in action--Part2-Spring On The Web | 曾先生&#39;s Blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/10/18/Spring in action--Part3-Spring in the back end/" title="Spring in action--Part3-Spring in the back end">
  <strong>上一篇：</strong><br/>
  <span>
  Spring in action--Part3-Spring in the back end</span>
</a>
</div>


<div class="next">
<a href="/2016/10/03/Spring in action--Part1-Core Spring/"  title="Spring in action--Part1-Core Spring">
 <strong>下一篇：</strong><br/> 
 <span>Spring in action--Part1-Core Spring
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2016/10/09/Spring in action--Part2-Spring On The Web/" data-title="Spring in action--Part2-Spring On The Web" data-url="http://yoursite.com/2016/10/09/Spring in action--Part2-Spring On The Web/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">Chapter5.Building Spring web applications</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.1.</span> <span class="toc-text">5.1Getting started with Spring MVC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">5.1.1Following the life of a request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">5.1.2Setting up Spring MVC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.1.3.</span> <span class="toc-text">5.1.3Introducing the Spittr application</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.2.</span> <span class="toc-text">5.2Writing a simple controller</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">5.2.1Testing the controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">5.2.2 Defining class-level request handling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.2.3.</span> <span class="toc-text">5.2.3Passing model data to the view</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.3.</span> <span class="toc-text">5.3Accepting request input</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.3.1.</span> <span class="toc-text">5.3.1Taking query parameters</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.3.2.</span> <span class="toc-text">5.3.2Taking input via path parameters</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.4.</span> <span class="toc-text">5.4Processing forms</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.4.1.</span> <span class="toc-text">5.4.1Writing a form-handling controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.4.2.</span> <span class="toc-text">5.4.2Validating forms</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">1.0.5.</span> <span class="toc-text">5.5Summary</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">Chapter6.Rendering web views</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.1.</span> <span class="toc-text">6.1Understanding view resolution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.2.</span> <span class="toc-text">6.2Creating JSP views</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.2.1.</span> <span class="toc-text">6.2.1Configuring a JSP-ready view resolver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.2.2.</span> <span class="toc-text">6.2.2Using Spring’s JSP libraries</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.3.</span> <span class="toc-text">6.3Defining a layout with Apache Tiles views</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.4.</span> <span class="toc-text">6.4Working with Thymeleaf</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.4.1.</span> <span class="toc-text">6.4.1Configuring a Thymeleaf view resolver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.4.2.</span> <span class="toc-text">6.4.2Defining Thymeleaf templates</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">2.0.5.</span> <span class="toc-text">6.5Summary</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">Chapter7.Advanced Spring MVC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.1.</span> <span class="toc-text">7.1Alternate Spring MVC configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.1.1.</span> <span class="toc-text">7.1.1Customizing DispatcherServlet configuration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.1.2.</span> <span class="toc-text">7.1.2Adding additional servlets and filters</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.1.3.</span> <span class="toc-text">7.1.3 Declaring DispatcherServlet in web.xml</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.2.</span> <span class="toc-text">7.2Processing multipart form data</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.2.1.</span> <span class="toc-text">7.2.1Configuring a multipart resolver</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.3.</span> <span class="toc-text">7.2Handling multipart requests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.4.</span> <span class="toc-text">7.3Handling exceptions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.4.1.</span> <span class="toc-text">7.3.1Mapping exceptions to HTTP status codes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.4.2.</span> <span class="toc-text">7.3.2Writing exception-handling methods</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.5.</span> <span class="toc-text">7.4Advising controllers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.6.</span> <span class="toc-text">7.5Carrying data across redirect requests</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.6.1.</span> <span class="toc-text">7.5.1Redirecting with URL templates</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.6.2.</span> <span class="toc-text">7.5.2Working with flash attributes</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.0.7.</span> <span class="toc-text">7.6Summary</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">Chapter8.Working with Spring Web Flow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.1.</span> <span class="toc-text">8.1Configuring Web Flow in Spring</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.1.1.</span> <span class="toc-text">8.1.1Wiring a flow executor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.1.2.</span> <span class="toc-text">8.1.2Configuring a flow registry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.1.3.</span> <span class="toc-text">8.1.3 Handling flow requests</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.2.</span> <span class="toc-text">8.2 The components of a flow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.2.1.</span> <span class="toc-text">8.2.1 States</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.2.2.</span> <span class="toc-text">8.2.2Transitions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.2.3.</span> <span class="toc-text">8.2.3Flow data</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.</span> <span class="toc-text">8.3Putting it all together: the pizza flow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.1.</span> <span class="toc-text">8.3.1Defining the base flow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.2.</span> <span class="toc-text">8.3.2Collecting customer information</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.3.</span> <span class="toc-text">8.3.3Building an order</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.3.4.</span> <span class="toc-text">8.3.4 Taking payment</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.4.</span> <span class="toc-text">8.4 Securing web flows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">4.0.5.</span> <span class="toc-text">8.5Summary</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">Chapter9.Securing web applications</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.1.</span> <span class="toc-text">9.1Getting started with Spring Security</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.1.1.</span> <span class="toc-text">9.1.1Understanding Spring Security modules</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.1.2.</span> <span class="toc-text">9.1.2Filtering web requests</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.1.3.</span> <span class="toc-text">9.1.3Writing a simple security configuration</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.</span> <span class="toc-text">9.2Selecting user details services</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.1.</span> <span class="toc-text">9.2.1Working with an in-memory user store</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.2.</span> <span class="toc-text">9.2.2Authenticating against database tables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.3.</span> <span class="toc-text">9.2.3Applying LDAP-backed authentication</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.2.4.</span> <span class="toc-text"> 9.2.4Configuring a custom user service</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.3.</span> <span class="toc-text">9.3Intercepting requests</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.3.1.</span> <span class="toc-text">9.3.1Securing with Spring Expressions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.3.2.</span> <span class="toc-text">9.3.2Enforcing channel security</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.3.3.</span> <span class="toc-text">9.3.3Preventing cross-site request forgery</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.</span> <span class="toc-text">9.4Authenticating users</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.1.</span> <span class="toc-text">9.4.1Adding a custom login page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.2.</span> <span class="toc-text">9.4.2 Enabling HTTP Basic authentication</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.3.</span> <span class="toc-text">9.4.3Enabling remember-me functionality</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.4.4.</span> <span class="toc-text">9.4.4Logging out</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.5.</span> <span class="toc-text">9.5Securing the view</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.5.1.</span> <span class="toc-text">9.5.1 Using Spring Security’s JSP tag library</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.5.2.</span> <span class="toc-text">9.5.2Working with Thymeleaf’s Spring Security dialect</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">5.0.6.</span> <span class="toc-text">9.6Summary</span></a></li></ol></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Java/" style="font-size: 13.33px;">Java</a> <a href="/tags/Java编程思想读书笔记/" style="font-size: 16.67px;">Java编程思想读书笔记</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/TECH/" style="font-size: 11.67px;">TECH</a> <a href="/tags/后端开发/" style="font-size: 18.33px;">后端开发</a> <a href="/tags/数据结构与算法分析/" style="font-size: 11.67px;">数据结构与算法分析</a> <a href="/tags/机器学习/" style="font-size: 13.33px;">机器学习</a> <a href="/tags/程序人生/" style="font-size: 10px;">程序人生</a> <a href="/tags/程序员修炼之道读书笔记/" style="font-size: 13.33px;">程序员修炼之道读书笔记</a> <a href="/tags/算法4读书笔记/" style="font-size: 15px;">算法4读书笔记</a>
    </div>
  </div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://lucida.me/" target="_blank" title="Lucida&#39;s Blog">Lucida&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://hukai.me/" target="_blank" title="Hukai&#39;s Blog">Hukai&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://gank.io/" target="_blank" title="GANK">GANK</a>
            
          </li>
        
          <li>
            
            	<a href="http://stormzhang.com/" target="_blank" title="StormZhang&#39;s Blog">StormZhang&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.trinea.cn/" target="_blank" title="Trinea&#39;s Blog">Trinea&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=2766fecb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello , I&#39;m Zeng Qi , a Android developer , love Java , ML and Big Data . <br/>
			This is my blog , hope you will enjoy it . Let&#39;s make this world a better place .</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/18600103348" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/zengqi-ustb" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		<a href="http://www.zhihu.com/people/ceng-qi-29" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
		<a href="mailto:zengqiustb@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		© 2016 
		
		<a href="/about" target="_blank" title="曾奇">曾奇</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"zengqi"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
